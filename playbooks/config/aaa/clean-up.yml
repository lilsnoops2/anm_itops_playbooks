---
- name: Standardize radius configuration with named method lists
  hosts: all
  gather_facts: no
  connection: network_cli
  vars_files:
    - ./vars/aaa-servers.yml

  vars:    
    ansible_become_password: "{{ enable | default(ansible_password) }}"
    ansible_become: true
    ansible_become_method: enable
    ignore_method_lists:
      - default
      - console
      - "1"
      - "5"
      - "15"
      - newinfo


  pre_tasks:

    - name: Prompt for username
      pause:
        prompt: "Enter username"
        echo: yes
      register: user_input
      when: ansible_user is not defined
      delegate_to: localhost
      run_once: true

    - name: Prompt for password
      pause:
        prompt: "Enter password"
        echo: no
      register: pass_input
      when: ansible_password is not defined
      delegate_to: localhost
      run_once: true
    
    - name: Prompt for organization prefix
      run_once: true
      delegate_to: localhost
      pause:
        prompt: "Enter your organization prefix (e.g., ANM, MST, LAB): "
      register: org_prefix_input
      when: prompt_for_prefix

    - name: Prompt for radius shared secret key
      pause:
        prompt: "Enter radius shared secret key (will not echo):"
        echo: no
      register: radius_key_prompt
      when: radius_key is not defined
      delegate_to: localhost
      run_once: true

    - name: Set username from prompt
      set_fact:
        ansible_user: "{{ user_input.user_input }}"
      when: user_input is defined and user_input.user_input is defined

    - name: Set password from prompt
      set_fact:
        ansible_password: "{{ pass_input.user_input }}"
      when: pass_input is defined and pass_input.user_input is defined


  tasks:

    - name: Get running config
      ios_command:
        commands:
          - show running-config
      register: run_cfg

    - name: Parse running config with Genie
      pyats_parse:
        command: show running-config
        output: "{{ run_cfg.stdout[0] }}"
      register: parsed

    - name: Extract AAA method list definitions
      set_fact:
        aaa_method_lists: >-
          {{
            parsed.parsed.aaa.authentication.login
            | default({})
            | dict2items
            | map(attribute='key')
            | difference(ignore_method_lists)
          }}

    - name: Extract AAA authorization method lists
      set_fact:
        aaa_method_lists: >-
          {{
            aaa_method_lists
            + (
              parsed.parsed.aaa.authorization.exec
              | default({})
              | dict2items
              | map(attribute='key')
              | difference(ignore_method_lists)
            )
          }}

    - name: Extract AAA accounting method lists
      set_fact:
        aaa_method_lists: >-
          {{
            aaa_method_lists
            + (
              parsed.parsed.aaa.accounting
              | default({})
              | dict2items
              | map(attribute='key')
              | difference(ignore_method_lists)
            )
          }}

    - name: Normalize method list set
      set_fact:
        aaa_method_lists: "{{ aaa_method_lists | unique }}"

    - name: Extract non-AAA config lines
      set_fact:
        non_aaa_lines: >-
          {{
            run_cfg.stdout[0].splitlines()
            | reject('match', '^aaa ')
            | list
          }}

    - name: Detect method lists used outside AAA
      set_fact:
        used_outside_aaa: >-
          {{
            aaa_method_lists
            | select(
                'in',
                non_aaa_lines | join(' ')
              )
            | list
          }}

    - name: Determine safe-to-remove method lists
      set_fact:
        safe_to_remove: "{{ aaa_method_lists | difference(used_outside_aaa) }}"

    - name: Show results
      debug:
        msg:
          defined: "{{ aaa_method_lists }}"
          used_outside_aaa: "{{ used_outside_aaa }}"
          safe_to_remove: "{{ safe_to_remove }}"

    - name: Remove unused AAA method lists
      ios_config:
        lines: "{{ safe_to_remove | map('regex_replace', '^(.*)$', 'no aaa authentication login \\1') | list }}"
      when: safe_to_remove | length > 0
