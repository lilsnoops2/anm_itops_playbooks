---
- name: Clean Up Radius Config
  hosts: all
  gather_facts: no
  connection: network_cli
  vars_files:
    - "{{ playbook_dir }}/vars/aaa-servers.yml"


  vars:    
    ansible_become_password: "{{ enable | default(ansible_password) }}"
    ansible_become: true
    ansible_become_method: enable
    tacacs_key: ""
    radius_key: ""
    ignore_method_lists:
      - default
      - console
      - "1"
      - "5"
      - "15"
      - newinfo


  pre_tasks:

    - name: Fail if aaa-servers.yml did not load
      fail:
        msg: "aaa-servers.yml did not load. Check vars_files path: {{ playbook_dir }}/vars/aaa-servers.yml"
      when: radius_servers is not defined or (radius_servers | length) == 0

    - name: Prompt for username
      pause:
        prompt: "Enter username"
        echo: yes
      register: user_input
      when: ansible_user is not defined
      delegate_to: localhost
      run_once: true

    - name: Prompt for password
      pause:
        prompt: "Enter password"
        echo: no
      register: pass_input
      when: ansible_password is not defined
      delegate_to: localhost
      run_once: true
    

    - name: Set username from prompt
      set_fact:
        ansible_user: "{{ user_input.user_input }}"
      when: user_input is defined and user_input.user_input is defined

    - name: Set password from prompt
      set_fact:
        ansible_password: "{{ pass_input.user_input }}"
      when: pass_input is defined and pass_input.user_input is defined

  tasks:

    - name: Collect RADIUS server objects and group blocks
      ios_command:
        commands:
          - "show running-config | section ^radius server"
          - "show running-config | section ^aaa group server radius"
      register: rad_collect

    - name: Normalize RADIUS config text
      set_fact:
        radius_obj_text: "{{ rad_collect.stdout[0] | default('') | string | replace('\r','') }}"
        radius_group_text: "{{ rad_collect.stdout[1] | default('') | string | replace('\r','') }}"


    - debug: msg="{{ radius_obj_text | regex_findall('radius') }}"
    - debug: msg="{{ radius_obj_text | regex_findall('radius\\s+server') }}"


    - name: Build allowed radius IP list from vars
      set_fact:
        allowed_radius_ips: >-
          {{
            (radius_servers | default([]))
            | map(attribute='ip')
            | select('defined')
            | map('string')
            | unique
            | list
          }}

    # ------------------------------------------------------------
    # Parse RADIUS server objects (name + ip) using explicit \n
    # (No DOTALL, no lookaheads, no multiline anchors)
    # ------------------------------------------------------------

    - name: Extract configured RADIUS server name/IP pairs (explicit newline)
      set_fact:
        configured_radius_pairs: >-
          {{
            radius_obj_text
            | regex_findall(
                'radius\\s+server\\s+(\\S+)\\n\\s*address\\s+ipv4\\s+(\\d{1,3}(?:\\.\\d{1,3}){3})\\b'
              )
          }}

    - name: Build configured radius map from pairs
      set_fact:
        configured_radius_map: "{{ (configured_radius_map | default([])) + [ {'name': item.0, 'ip': item.1} ] }}"
      loop: "{{ configured_radius_pairs | default([]) }}"

    - name: Normalize configured radius map
      set_fact:
        configured_radius_map: "{{ configured_radius_map | default([]) | unique | list }}"

    # ------------------------------------------------------------
    # Parse RADIUS group blocks without DOTALL:
    # Grab each group block as:
    #   aaa group server radius <GROUP>\n
    #   (zero or more " server name <X>\n" lines)
    # This pattern does not need DOTALL because it never uses "."
    # across newlines; it uses explicit "\n" pieces.
    # ------------------------------------------------------------

    - name: Extract radius group blocks (explicit newline pattern)
      set_fact:
        radius_group_blocks: >-
          {{
            radius_group_text
            | regex_findall(
                'aaa\\s+group\\s+server\\s+radius\\s+\\S+\\n(?:\\s*server\\s+name\\s+\\S+\\n?)*'
              )
          }}

    - name: Initialize group_members and group list
      set_fact:
        group_members: {}
        radius_groups_configured: []

    - name: Build group_members map (group -> server names)
      set_fact:
        radius_groups_configured: "{{ (radius_groups_configured | default([])) + [grp] }}"
        group_members: "{{ group_members | combine({ grp: servers }, recursive=True) }}"
      loop: "{{ radius_group_blocks | default([]) }}"
      loop_control:
        loop_var: block
      vars:
        grp: "{{ (block | regex_findall('aaa\\s+group\\s+server\\s+radius\\s+(\\S+)') | first | default('')) }}"
        servers: "{{ block | regex_findall('server\\s+name\\s+(\\S+)') | unique | list }}"

    - name: Normalize group list
      set_fact:
        radius_groups_configured: "{{ radius_groups_configured | default([]) | reject('equalto','') | unique | list }}"

    # ------------------------------------------------------------
    # Determine which RADIUS servers must be removed (by IP)
    # ------------------------------------------------------------

    - name: Compute radius servers to remove (IP not in vars)
      set_fact:
        radius_servers_to_remove: >-
          {{
            (configured_radius_map | default([]))
            | rejectattr('ip', 'in', allowed_radius_ips | default([]))
            | list
          }}

    - name: Compute derived removal lists
      set_fact:
        radius_names_to_remove: "{{ (radius_servers_to_remove | default([])) | map(attribute='name') | unique | list }}"
        radius_ips_to_remove: "{{ (radius_servers_to_remove | default([])) | map(attribute='ip') | unique | list }}"

    # ------------------------------------------------------------
    # Unlink from groups FIRST
    # ------------------------------------------------------------

    - name: Build unlink commands for radius groups
      set_fact:
        radius_unlink_lines: "{{ (radius_unlink_lines | default([])) + unlink_cmds }}"
      loop: "{{ radius_groups_configured | default([]) }}"
      loop_control:
        loop_var: grp
      vars:
        bad_servers_in_group: "{{ (group_members.get(grp, []) | default([])) | intersect(radius_names_to_remove | default([])) }}"
        unlink_cmds: >-
          {{
            (
              ['aaa group server radius ' ~ grp]
              +
              (bad_servers_in_group | map('regex_replace', '^(.*)$', 'no server name \\1') | list)
            )
            if (bad_servers_in_group | length > 0)
            else []
          }}

    # ------------------------------------------------------------
    # SHOW PLAN
    # ------------------------------------------------------------

    - name: Show RADIUS unlink/delete plan
      debug:
        msg:
          allowed_radius_ips: "{{ allowed_radius_ips }}"
          configured_radius_pairs: "{{ configured_radius_pairs | default([]) }}"
          configured_radius_map: "{{ configured_radius_map | default([]) }}"
          radius_ips_to_remove: "{{ radius_ips_to_remove | default([]) }}"
          radius_names_to_remove: "{{ radius_names_to_remove | default([]) }}"
          radius_groups_configured: "{{ radius_groups_configured | default([]) }}"
          group_members: "{{ group_members | default({}) }}"
          radius_unlink_lines: "{{ radius_unlink_lines | default([]) }}"

    # ------------------------------------------------------------
    # APPLY CHANGES
    # ------------------------------------------------------------

    - name: Unlink bad RADIUS servers from groups
      ios_config:
        lines: "{{ radius_unlink_lines }}"
      when: (radius_unlink_lines | default([])) | length > 0

    - name: Delete bad RADIUS server objects
      ios_config:
        lines: "{{ radius_names_to_remove | map('regex_replace', '^(.*)$', 'no radius server \\1') | list }}"
      when: (radius_names_to_remove | default([])) | length > 0
