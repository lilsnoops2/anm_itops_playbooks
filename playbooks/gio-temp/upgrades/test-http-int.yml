---
- name: Update HTTP Source int
  hosts: localhost
  gather_facts: false

  vars_prompt:
    - name: target_hosts
      prompt: |
        Available groups:
        {% for g in groups.keys() | sort %}
        - {{ g }}
        {% endfor %}
        
        Enter host(s) or group(s) separated by commas (e.g., router,switch1,switch4)
      private: no
    
  tasks:
    - name: Store answers as facts for next play
      set_fact:
        target_hosts: "{{ target_hosts }}"
      run_once: true
      no_log: true

- name: IOSXE Upgrade Playbook
  hosts: "{{ hostvars['localhost']['target_hosts'].split(',') }}"
  gather_facts: false
  connection: network_cli

  vars_prompt:
    - name: ansible_user
      prompt: "Enter username"
      private: no
    - name: ansible_password
      prompt: "Enter password" 
      private: yes

  tasks:
    - name: Run on IOS devices
      ios_command:
        commands:
          - "show ip interface brief | include {{ ansible_host }}"
      register: ip_brief
      when: ansible_network_os == "ios"
      ignore_errors: yes

    - name: Run on IOS XR devices
      iosxr_command:
        commands:
          - "show ipv4 interface brief | include {{ ansible_host }}"
      register: ip_brief
      when: ansible_network_os == "iosxr"
      ignore_errors: yes

    - name: Run on NX-OS devices
      nxos_command:
        commands:
          - "show ip interface brief | include {{ ansible_host }}"
      register: ip_brief
      when: ansible_network_os == "nxos"
      ignore_errors: yes

    - name: Extract interface name from 'show ip interface brief' output
      set_fact:
        ssh_interface: "{{ ip_brief.stdout[0] | regex_search('^(\\S+)', '\\1') }}"
      when:
        - ip_brief is defined
        - ip_brief.stdout is defined
        - ip_brief.stdout[0] | trim != ''

    - name: Parse running-config for interface that has 'ip address <ansible_host>'
      set_fact:
        ssh_interface: >-
          {{ (
             run_cfg.stdout[0].split('\ninterface ')[
               # create list of interface blocks and select first block that contains the IP
               ] | select('search', ('ip address\\s+' + (ansible_host|regex_escape) + '\\b')) | list
           )[0] | regex_search('^([^\\n]+)', '\\1') }}
      when:
        - ssh_interface is not defined
        - run_cfg is defined
        - run_cfg.stdout is defined
        - run_cfg.stdout[0] | trim != ''

    - name: Report result
      debug:
        msg: >-
          {% if ssh_interface is defined and ssh_interface|length > 0 %}
            Interface for SSH IP {{ ansible_host }}: {{ ssh_interface }}
          {% else %}
            No interface found with IP {{ ansible_host }}.
            Outputs collected:
            show ip interface brief: {{ ip_brief.stdout if (ip_brief is defined) else 'n/a' }}
          {% endif %}

    - name: Confirmation
      run_once: true
      delegate_to: localhost
      vars:
        summary: "CAUTION: review the above interfaces carefully before proceeding"
      block:
        - name: Confirm before deletion
          pause:
            prompt: "Type 'yes' to proceed with cleanup: "
          register: confirm
        - name: Abort if not confirmed
          fail:
            msg: "User cancelled configuration."
          when: confirm.user_input | lower != 'yes'

    - name: Set HTTP source interface on IOS
      ios_config:
        lines:
          - ip http client source-interface {{ ssh_interface }}
        save_when: always
      when: ansible_network_os == "ios"

    - name: Set HTTP source interface on IOS XR
      iosxr_config:
        lines:
          - http client source-interface {{ ssh_interface }}
        commit: yes
      when: ansible_network_os == "iosxr"

    - name: Set HTTP source interface on NX-OS
      nxos_config:
        lines:
          - ip http client source-interface {{ ssh_interface }}
        save_when: always
      when: ansible_network_os == "nxos"