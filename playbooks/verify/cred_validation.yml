---

- name: Multi-credential tester for Cisco/Palo Alto platforms
  hosts: all
  gather_facts: false

  pre_tasks:

    - name: Ensure credential_sets variable is provided
      fail:
        msg: |
          ERROR: No credential sets provided.

          You must supply one or more credential sets using:

            -e '
            credential_sets:
              - { name: "set1", username: "admin", password: "pass123" }
              - { name: "set2", username: "ops", password: "Cisco123" }
            '

          OR using a variables file:

            -e @./vars/creds.yml
      when: credential_sets is not defined or credential_sets | length == 0

  vars:
    device_result:
      success: false
      using_cred: none

  tasks:

    - name: Try all provided credential sets
      include_tasks: cred_validation_try.yml
      loop: "{{ credential_sets }}"
      loop_control:
        loop_var: cred
      when: not device_result.success

    - name: Final output for device
      debug:
        msg: >-
          {{ inventory_hostname }} â†’
          {% if device_result.success %}
            SUCCESS using {{ device_result.using_cred }}
          {% else %}
            FAILED (no credential sets worked)
          {% endif %}
