---
- name: Standardize TACACS+ configuration with named method lists
  hosts: all
  gather_facts: no
  connection: network_cli
  vars_files:
    - ./tacacs-servers.yml

  vars:
    organization_prefix: "{{ org_prefix | default('') }}"
    prompt_for_prefix: "{{ organization_prefix == '' }}"
    tacacs_group_name: "{{ organization_prefix }}-TACACS"
    auth_method_list: "{{ organization_prefix }}-authc"
    authz_method_list: "{{ organization_prefix }}-authz"

  pre_tasks:

    - name: Prompt for username
      pause:
        prompt: "Enter username"
        echo: yes
      register: user_input
      when: ansible_user is not defined
      delegate_to: localhost
      run_once: true

    - name: Prompt for password
      pause:
        prompt: "Enter password"
        echo: no
      register: pass_input
      when: ansible_password is not defined
      delegate_to: localhost
      run_once: true
    
    - name: Prompt for organization prefix
      run_once: true
      delegate_to: localhost
      pause:
        prompt: "Enter your organization prefix (e.g., ANM, MST, LAB): "
      register: org_prefix_input
      when: prompt_for_prefix

    - name: Set username from prompt
      set_fact:
        ansible_user: "{{ user_input.user_input }}"
      when: user_input is defined and user_input.user_input is defined

    - name: Set password from prompt
      set_fact:
        ansible_password: "{{ pass_input.user_input }}"
      when: pass_input is defined and pass_input.user_input is defined

    - name: Set organization prefix from prompt
      set_fact:
        organization_prefix: "{{ org_prefix_input.user_input | upper }}"
      when: prompt_for_prefix

    - name: Update naming convention variables
      set_fact:
        tacacs_group_name: "{{ organization_prefix }}-TACACS"
        auth_method_list: "{{ organization_prefix }}-authc"
        authz_method_list: "{{ organization_prefix }}-authz"

  tasks:
    ##########################################################
    # 0. Pre Tasks
    ##########################################################
    - name: Set Vars for enable
      set_fact:
        ansible_become_password: "{{ ansible_password }}"
        ansible_become: true
        ansible_become_method: enable
      run_once: true
      no_log: true

    ##########################################################
    # 1. Gather existing TACACS configuration
    ##########################################################
    - name: Get current TACACS configuration
      ios_command:
        commands:
          - "show running-config | include tacacs"
      register: ios_tacacs_config
      when: ansible_network_os in ['ios', 'iosxe']

    - name: Extract existing tacacs server names
      set_fact:
        existing_named_servers: "{{ ios_tacacs_config.stdout[0] | regex_findall('tacacs server ([A-Za-z0-9_.-]+)') }}"
      when: ansible_network_os in ['ios', 'iosxe']

    ##########################################################
    # 2. Remove stale or deprecated TACACS configurations
    ##########################################################
    - name: Remove deprecated tacacs-server host commands
      ios_config:
        lines: "{{ ios_tacacs_config.stdout[0] | regex_findall('tacacs-server host ([0-9.]+)') | map('regex_replace', '^(.*)$', 'no tacacs-server host \\1') | list }}"
      when:
        - ansible_network_os in ['ios', 'iosxe']
        - ios_tacacs_config.stdout[0] is search('tacacs-server host')
      ignore_errors: yes

    - name: Remove TACACS servers not in tacacs-servers.yml
      ios_config:
        lines: "{{ existing_named_servers | difference(tacacs_servers | map(attribute='name') | list) | map('regex_replace', '^(.*)$', 'no tacacs server \\1') | list }}"
      when:
        - ansible_network_os in ['ios', 'iosxe']
        - existing_named_servers | difference(tacacs_servers | map(attribute='name') | list) | length > 0

    ##########################################################
    # 3. Configure named TACACS+ servers
    ##########################################################
    - name: Configure named TACACS+ servers (IOS/IOS-XE)
      ios_config:
        parents: "tacacs server {{ item.name }}"
        lines:
          - "address ipv4 {{ item.address }} port {{ item.port | default(49) }}"
          - "key {{ item.key }}"
        match: line
      loop: "{{ tacacs_servers }}"
      when: ansible_network_os in ['ios', 'iosxe']

    ##########################################################
    # 4. Configure TACACS+ server group
    ##########################################################
    - name: Configure TACACS+ server group
      ios_config:
        parents: "aaa group server tacacs+ {{ tacacs_group_name }}"
        lines:
          - "server name {{ item.name }}"
        match: line
      loop: "{{ tacacs_servers }}"
      when: ansible_network_os in ['ios', 'iosxe']

    ##########################################################
    # 5. Enforce AAA baseline configuration
    ##########################################################
    - name: Enforce AAA authentication/authorization/accounting
      ios_config:
        lines:
          - "aaa authentication login {{ auth_method_list }} group {{ tacacs_group_name }} local enable"
          - "aaa authentication enable default group {{ tacacs_group_name }} enable"
          - "aaa authorization exec {{ authz_method_list }} group {{ tacacs_group_name }} local if-authenticated"
          - "aaa accounting commands 1 default start-stop group {{ tacacs_group_name }}"
          - "aaa accounting commands 15 default start-stop group {{ tacacs_group_name }}"
        match: line
      when: ansible_network_os in ['ios', 'iosxe']

    ##########################################################
    # 6. Configure VTY line authentication
    ##########################################################
    - name: Get VTY line ranges
      ios_command:
        commands:
          - "show line | include VTY"
      register: vty_lines_output
      when: ansible_network_os in ['ios', 'iosxe']

    - name: Parse VTY lines into groups
      set_fact:
        vty_ranges: "{{ vty_lines_output.stdout[0] | regex_findall('\\s+(\\d+)\\s+VTY') | map('int') | sort }}"
        vty_groups: >-
          {% set groups = [] %}
          {% set current = [] %}
          {% for line in vty_ranges %}
            {% if current | length == 0 or line == (current[-1] + 1) %}
              {% set _ = current.append(line) %}
            {% else %}
              {% set _ = groups.append(current) %}
              {% set current = [line] %}
            {% endif %}
          {% endfor %}
          {% if current | length > 0 %}
            {% set _ = groups.append(current) %}
          {% endif %}
          {{ groups }}
      when: ansible_network_os in ['ios', 'iosxe']

    - name: Enforce VTY line login & authorization
      ios_config:
        parents: "line vty {{ item[0] }} {{ item[-1] }}"
        lines:
          - "login authentication {{ auth_method_list }}"
          - "authorization exec {{ authz_method_list }}"
        match: line
      loop: "{{ vty_groups }}"
      when:
        - ansible_network_os in ['ios', 'iosxe']
        - vty_groups | length > 0

    ##########################################################
    # 7. Save and verify
    ##########################################################
    - name: Save running configuration
      ios_command:
        commands:
          - "write memory"
      when: ansible_network_os in ['ios', 'iosxe']

    - name: Verify TACACS+ and AAA configuration
      ios_command:
        commands:
          - "show running-config | section tacacs"
          - "show running-config | section aaa"
          - "show running-config | section line vty"
      register: verify_config
      when: ansible_network_os in ['ios', 'iosxe']

    - name: Display verification summary
      debug:
        msg: |
          TACACS+ Configuration Verified
          --------------------------------
          Group: {{ tacacs_group_name }}
          Authentication: {{ auth_method_list }}
          Authorization: {{ authz_method_list }}
          Servers: {{ tacacs_servers | map(attribute='name') | join(', ') }}

          --- Device Configuration Snapshot ---
          {{ verify_config.stdout | to_nice_yaml }}