---
- name: Update HTTP Source Interface
  hosts: localhost
  gather_facts: false

  vars_prompt:
    - name: target_hosts
      prompt: |
        Available groups:
        {% for g in groups.keys() | sort %}
        - {{ g }}
        {% endfor %}
        
        Enter host(s) or group(s) separated by commas (e.g., router,switch1,switch4)
      private: no

  tasks:
    - name: Store target hosts for next play
      set_fact:
        target_hosts: "{{ target_hosts }}"
      run_once: true
      no_log: true


- name: Update HTTP Source Interface on Devices
  hosts: "{{ hostvars['localhost']['target_hosts'].split(',') }}"
  gather_facts: false
  connection: network_cli

  vars_prompt:
    - name: ansible_user
      prompt: "Enter username"
      private: no
    - name: ansible_password
      prompt: "Enter password"
      private: yes

  tasks:

    ####################################################################
    # Step 1: Run platform-specific show commands to find SSH interface
    ####################################################################

    - name: Run on IOS
      ios_command:
        commands:
          - "show ip interface brief | include {{ ansible_host }}"
      register: ip_brief
      when: ansible_network_os == "ios"
      ignore_errors: yes

    - name: Run on IOS XR
      iosxr_command:
        commands:
          - "show ipv4 interface brief | include {{ ansible_host }}"
      register: ip_brief
      when: ansible_network_os == "iosxr"
      ignore_errors: yes

    - name: Run on NX-OS
      nxos_command:
        commands:
          - "show ip interface brief | include {{ ansible_host }}"
      register: ip_brief
      when: ansible_network_os == "nxos"
      ignore_errors: yes


    ####################################################################
    # Step 2: Extract and clean interface name
    ####################################################################

    - name: Extract raw interface name
      set_fact:
        ssh_interface_raw: "{{ ip_brief.stdout[0] | regex_search('^(\\S+)', '\\1') | default('') }}"
      when:
        - ip_brief is defined
        - ip_brief.stdout is defined

    - name: Normalize ssh_interface variable
      set_fact:
        ssh_interface: >-
          {{ ssh_interface_raw
            | replace('[','')
            | replace(']','')
            | replace("'",'')
            | replace('"','')
            | trim }}
      when: ssh_interface_raw is defined


    - name: Debug the detected interface
      debug:
        msg: "Interface for SSH IP {{ ansible_host }} â†’ {{ ssh_interface }}"


    ####################################################################
    # Step 3: Configure HTTP client source-interface
    ####################################################################

    - name: Set HTTP source interface on IOS
      ios_config:
        lines:
          - ip http client source-interface {{ ssh_interface }}
        save_when: always
      when:
        - ansible_network_os == "ios"
        - ssh_interface is defined and ssh_interface | length > 0

    - name: Set HTTP source interface on IOS XR
      iosxr_config:
        lines:
          - http client source-interface {{ ssh_interface }}
        commit: yes
      when:
        - ansible_network_os == "iosxr"
        - ssh_interface is defined and ssh_interface | length > 0

    - name: Set HTTP source interface on NX-OS
      nxos_config:
        lines:
          - ip http client source-interface {{ ssh_interface }}
        save_when: always
      when:
        - ansible_network_os == "nxos"
        - ssh_interface is defined and ssh_interface | length > 0
