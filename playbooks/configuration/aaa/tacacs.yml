#ansible-playbook playbooks/configuration/aaa/tacacs.yml -l 'c9200l' -e 'organization_prefix=ANM' -e 'ansible_user=user' -e 'ansible_password=password' -e 'tacacs_key=tacacs123'
---
- name: Standardize TACACS+ configuration with named method lists
  hosts: all
  gather_facts: no
  connection: network_cli
  vars_files:
    - ./vars/aaa-servers.yml

  vars:
    organization_prefix: "{{ org_prefix | default('') }}"
    prompt_for_prefix: "{{ organization_prefix == '' }}"
    tacacs_group_name: "{{ organization_prefix }}-TACACS"
    auth_method_list: "{{ organization_prefix }}-authc"
    authz_method_list: "{{ organization_prefix }}-authz"
    ansible_become_password: "{{ enable | default(ansible_password) }}"
    ansible_become: true
    ansible_become_method: enable


  pre_tasks:

    - name: Prompt for username
      pause:
        prompt: "Enter username"
        echo: yes
      register: user_input
      when: ansible_user is not defined
      delegate_to: localhost
      run_once: true

    - name: Prompt for password
      pause:
        prompt: "Enter password"
        echo: no
      register: pass_input
      when: ansible_password is not defined
      delegate_to: localhost
      run_once: true
    
    - name: Prompt for organization prefix
      run_once: true
      delegate_to: localhost
      pause:
        prompt: "Enter your organization prefix (e.g., ANM, MST, LAB): "
      register: org_prefix_input
      when: prompt_for_prefix

    - name: Prompt for TACACS shared secret key
      pause:
        prompt: "Enter TACACS+ shared secret key (will not echo):"
        echo: no
      register: tacacs_key_prompt
      when: tacacs_key is not defined
      delegate_to: localhost
      run_once: true

    - name: Set username from prompt
      set_fact:
        ansible_user: "{{ user_input.user_input }}"
      when: user_input is defined and user_input.user_input is defined

    - name: Set password from prompt
      set_fact:
        ansible_password: "{{ pass_input.user_input }}"
      when: pass_input is defined and pass_input.user_input is defined

    - name: Set organization prefix from prompt
      set_fact:
        organization_prefix: "{{ org_prefix_input.user_input | upper }}"
      when: prompt_for_prefix

    - name: Update naming convention variables
      set_fact:
        tacacs_group_name: "{{ organization_prefix }}-TACACS"
        auth_method_list: "{{ organization_prefix }}-authc"
        authz_method_list: "{{ organization_prefix }}-authz"

    - name: Set TACACS key variable
      set_fact:
        tacacs_key: "{{ tacacs_key_prompt.user_input }}"
      when: tacacs_key is not defined


    - name: Ensure AAA new-model is enabled
      ios_config:
        lines:
          - "aaa new-model"
        save_when: modified
      when: ansible_network_os in ['ios', 'iosxe']


  tasks:
    ##########################################################
    # 1. Gather existing TACACS configuration
    ##########################################################
    - name: Get current TACACS configuration
      ios_command:
        commands:
          - "show running-config | include tacacs"
      register: ios_tacacs_config
      when: ansible_network_os in ['ios', 'iosxe']

    - name: Extract existing tacacs server names
      set_fact:
        existing_named_servers: "{{ ios_tacacs_config.stdout[0] | regex_findall('tacacs server ([A-Za-z0-9_.-]+)') }}"
      when: ansible_network_os in ['ios', 'iosxe']

    ##########################################################
    # 2. Configure named TACACS+ servers
    ##########################################################
    - name: Parse existing TACACS servers (name â†’ IP)
      set_fact:
        existing_servers_map: >-
          {{
            dict(
              ios_tacacs_config.stdout[0]
              | regex_findall('^tacacs server (\S+)\s*(?:\n\s+address ipv4 ([0-9.]+))?', multiline=True)
            )
          }}

    - name: Build final TACACS server list safely
      set_fact:
        tacacs_servers_final: []

    - name: Determine final names for TACACS servers
      set_fact:
        tacacs_servers_final: >-
          {{
            tacacs_servers_final + [
              item | combine({
                'final_name': (
                  existing_servers_map[item.address]
                  if item.address in existing_servers_map
                  else item.name
                )
              })
            ]
          }}
      loop: "{{ tacacs_servers }}"
          
    - name: Create TACACS servers only if IP is not already configured
      ios_config:
        parents: "tacacs server {{ item.name }}"
        lines:
          - "address ipv4 {{ item.address }}"
          - "key {{ item.key }}"
        match: exact
      loop: "{{ tacacs_servers_final }}"
      when: item.final_name not in existing_servers_map

    # - name: Remove named TACACS servers not in YAML
    #   ios_config:
    #     lines: >-
    #       {{
    #         existing_named_servers 
    #         | difference(tacacs_servers | map(attribute='name') | list)
    #         | map('regex_replace', '^(.*)$', 'no tacacs server \\1')
    #         | list
    #       }}
    #   when:
    #     - ansible_network_os in ['ios', 'iosxe']
    #     - existing_named_servers | difference(tacacs_servers | map(attribute='name') | list) | length > 0

    # - name: Configure named TACACS+ servers (IOS/IOS-XE)
    #   ios_config:
    #     parents: "tacacs server {{ item.name }}"
    #     lines:
    #       - "address ipv4 {{ item.address }}"
    #       - "key {{ item.key }}"
    #     match: line
    #   loop: "{{ tacacs_servers }}"
    #   when: ansible_network_os in ['ios', 'iosxe']
    #   no_log: true

    ##########################################################
    # 3. Configure TACACS+ server group
    ##########################################################
    - name: Configure TACACS+ server group
      ios_config:
        parents: "aaa group server tacacs+ {{ tacacs_group_name }}"
        lines:
          - "server name {{ item.final_name }}"
      loop: "{{ tacacs_servers_final }}"


    # - name: Configure TACACS+ server group
    #   ios_config:
    #     parents: "aaa group server tacacs+ {{ tacacs_group_name }}"
    #     lines:
    #       - "server name {{ item.name }}"
    #     match: line
    #   loop: "{{ tacacs_servers }}"
    #   when: ansible_network_os in ['ios', 'iosxe']

    ##########################################################
    # 4. Enforce AAA baseline configuration
    ##########################################################
    - name: Enforce AAA authentication/authorization/accounting
      ios_config:
        lines:
          - "aaa authentication login {{ auth_method_list }} group {{ tacacs_group_name }} local enable"
          - "aaa authentication enable default group {{ tacacs_group_name }} enable"
          - "aaa authorization exec {{ authz_method_list }} group {{ tacacs_group_name }} local if-authenticated"
          - "aaa accounting commands 1 default start-stop group {{ tacacs_group_name }}"
          - "aaa accounting commands 15 default start-stop group {{ tacacs_group_name }}"
        match: line
      when: ansible_network_os in ['ios', 'iosxe']

    ##########################################################
    # 5. Configure VTY line authentication
    ##########################################################
    - name: Get available VTY lines
      ios_command:
        commands:
          - "show running-config | section line vty"
      register: vty_lines_output
      when: ansible_network_os in ['ios', 'iosxe']

    - name: Parse VTY line ranges (e.g., 0 4, 5 15, 0 31)
      set_fact:
        vty_groups: "{{ vty_lines_output.stdout[0] | regex_findall('line vty (\\d+)\\s+(\\d+)') | map('map', 'int') | list }}"
      when: ansible_network_os in ['ios', 'iosxe']

    - name: Configure VTY line login and authorization ranges
      ios_config:
        parents: "line vty {{ item.0 }} {{ item.1 }}"
        lines:
          - "login authentication {{ auth_method_list }}"
          - "authorization exec {{ authz_method_list }}"
        match: line
      loop: "{{ vty_groups }}"
      loop_control:
        label: "VTY {{ item.0 }}-{{ item.1 }}"
      when:
        - ansible_network_os in ['ios', 'iosxe']
        - vty_groups | length > 0

    ##########################################################
    # 6. Remove stale or deprecated TACACS configurations
    ##########################################################
    - name: Remove all deprecated tacacs-server commands
      ios_config:
        lines: >-
          {{
            ios_tacacs_config.stdout[0]
            | regex_findall('^tacacs-server.*')
            | map('regex_replace', '^(.*)$', 'no \\1')
            | list
          }}
      when:
        - ansible_network_os in ['ios', 'iosxe']
        - ios_tacacs_config.stdout[0] is search('tacacs-server')
      ignore_errors: yes


    ##########################################################
    # 7. Save and verify
    ##########################################################
    - name: Save running configuration
      ios_command:
        commands:
          - "write memory"
      when: ansible_network_os in ['ios', 'iosxe']

    - name: Verify TACACS+ and AAA configuration
      ios_command:
        commands:
          - "show running-config | section tacacs"
          - "show running-config | section aaa"
          - "show running-config | section line vty"
      register: verify_config
      when: ansible_network_os in ['ios', 'iosxe']

    - name: Display verification summary
      debug:
        msg: |
          TACACS+ Configuration Verified
          --------------------------------
          Group: {{ tacacs_group_name }}
          Authentication: {{ auth_method_list }}
          Authorization: {{ authz_method_list }}
          Servers: {{ tacacs_servers | map(attribute='name') | join(', ') }}

          --- TACACS+ Section ---
          {{ verify_config.stdout[0] | default('N/A') }}

          --- AAA Section ---
          {{ verify_config.stdout[1] | default('N/A') }}

          --- VTY Lines Section ---
          {{ verify_config.stdout[2] | default('N/A') }}