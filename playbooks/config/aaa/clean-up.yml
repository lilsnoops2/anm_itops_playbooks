---
- name: Clean Up Radius Config
  hosts: all
  gather_facts: no
  connection: network_cli
  vars_files:
    - ./vars/aaa-servers.yml

  vars:    
    ansible_become_password: "{{ enable | default(ansible_password) }}"
    ansible_become: true
    ansible_become_method: enable
    ignore_method_lists:
      - default
      - console
      - "1"
      - "5"
      - "15"
      - newinfo


  pre_tasks:

    - name: Prompt for username
      pause:
        prompt: "Enter username"
        echo: yes
      register: user_input
      when: ansible_user is not defined
      delegate_to: localhost
      run_once: true

    - name: Prompt for password
      pause:
        prompt: "Enter password"
        echo: no
      register: pass_input
      when: ansible_password is not defined
      delegate_to: localhost
      run_once: true
    

    - name: Set username from prompt
      set_fact:
        ansible_user: "{{ user_input.user_input }}"
      when: user_input is defined and user_input.user_input is defined

    - name: Set password from prompt
      set_fact:
        ansible_password: "{{ pass_input.user_input }}"
      when: pass_input is defined and pass_input.user_input is defined


  tasks:
    - name: Get running config
      ios_command:
        commands:
          - show running-config
      register: run_cfg

    - name: Normalize running-config
      set_fact:
        run_text: "{{ run_cfg.stdout[0] | replace('\r','') }}"
        run_lines: "{{ (run_cfg.stdout[0] | replace('\r','')).splitlines() }}"

    # ------------------------------------------------------------
    # A) METHOD LIST CLEANUP
    #    1) collect method-list names from aaa auth/author/acct lines
    #    2) check usage outside aaa
    #    3) remove the exact aaa lines that define those lists
    # ------------------------------------------------------------

    - name: Collect AAA method-list names (broad)
      set_fact:
        aaa_method_lists: >-
          {{
            (
              (run_text | regex_findall('(?m)^\\s*aaa\\s+authentication\\s+\\S+\\s+(\\S+)\\b'))
              +
              (run_text | regex_findall('(?m)^\\s*aaa\\s+authorization\\s+\\S+(?:\\s+\\d+)?\\s+(\\S+)\\b'))
              +
              (run_text | regex_findall('(?m)^\\s*aaa\\s+accounting\\s+\\S+(?:\\s+\\d+)?\\s+(\\S+)\\b'))
            )
            | difference(ignore_method_lists)
            | unique
            | list
          }}

    - name: Build non-AAA text
      set_fact:
        non_aaa_text: >-
          {{
            run_lines
            | reject('match', '^\\s*aaa\\b')
            | join('\n')
          }}

    - name: Detect method lists used outside AAA
      set_fact:
        used_outside_aaa: "{{ (used_outside_aaa | default([])) + ([item] if (non_aaa_text is regex_search(rx)) else []) }}"
      loop: "{{ aaa_method_lists }}"
      vars:
        rx: "(?m)(?:^|[^A-Za-z0-9_\\-]){{ item | regex_escape }}(?:$|[^A-Za-z0-9_\\-])"

    - name: Determine safe-to-remove method lists
      set_fact:
        safe_to_remove_lists: "{{ aaa_method_lists | difference(used_outside_aaa | default([])) | unique }}"

    # Build the exact AAA lines to remove (only lines that define the list)
    - name: Build AAA removal lines for safe method lists
      set_fact:
        aaa_lines_to_remove: "{{ (aaa_lines_to_remove | default([])) + matched_lines }}"
      loop: "{{ safe_to_remove_lists }}"
      vars:
        # grab all aaa lines where the 3rd-ish token is the method list name (varies by family)
        matched_lines: >-
          {{
            (
              # authentication lines: aaa authentication <type> <LIST> ...
              run_text | regex_findall('(?m)^\\s*aaa\\s+authentication\\s+\\S+\\s+' ~ (item|regex_escape) ~ '\\b.*$')
            )
            +
            (
              # authorization lines: aaa authorization <type> [<level>] <LIST> ...
              run_text | regex_findall('(?m)^\\s*aaa\\s+authorization\\s+\\S+(?:\\s+\\d+)?\\s+' ~ (item|regex_escape) ~ '\\b.*$')
            )
            +
            (
              # accounting lines: aaa accounting <type> [<level>] <LIST> ...
              run_text | regex_findall('(?m)^\\s*aaa\\s+accounting\\s+\\S+(?:\\s+\\d+)?\\s+' ~ (item|regex_escape) ~ '\\b.*$')
            )
          }}

    - name: Normalize AAA removal line list
      set_fact:
        aaa_lines_to_remove: "{{ (aaa_lines_to_remove | default([])) | unique | list }}"

    # ------------------------------------------------------------
    # B) RADIUS "UNUSED SERVER" CLEANUP
    #    Works for:
    #      radius server NAME
    #      aaa group server radius GROUP
    #        server name NAME
    # ------------------------------------------------------------

    - name: Find configured RADIUS groups
      set_fact:
        radius_groups_configured: "{{ (run_text | regex_findall('(?m)^\\s*aaa\\s+group\\s+server\\s+radius\\s+(\\S+)')) | unique | list }}"

    # A group is considered "referenced" if it appears on any AAA line as "group <GROUP>"
    # (we ignore its own definition block)
    - name: Find referenced RADIUS groups (from AAA statements)
      set_fact:
        radius_groups_referenced: "{{ (radius_groups_referenced | default([])) + ([item] if (run_text is regex_search(rx)) else []) }}"
      loop: "{{ radius_groups_configured }}"
      vars:
        # Look for "group <GROUP>" on AAA policy lines
        rx: "(?m)^\\s*aaa\\s+(?:authentication|authorization|accounting)\\s+.*\\bgroup\\s+{{ item | regex_escape }}\\b"

    - name: Compute unused RADIUS groups
      set_fact:
        radius_groups_unused: "{{ radius_groups_configured | difference(radius_groups_referenced | default([])) | unique | list }}"

    - name: Extract server names inside unused RADIUS group blocks
      set_fact:
        servers_in_unused_groups: "{{ (servers_in_unused_groups | default([])) + names }}"
      loop: "{{ radius_groups_unused }}"
      vars:
        group_body: >-
          {{
            (run_text
              | regex_findall('(?ms)^\\s*aaa\\s+group\\s+server\\s+radius\\s+' ~ (item | regex_escape) ~ '\\s*\\n(.*?)(?=^\\S|\\Z)')
              | first
              | default('')
            )
          }}
        names: "{{ group_body | regex_findall('(?m)^\\s*server\\s+name\\s+(\\S+)\\b') | unique | list }}"

    - name: Normalize servers found in unused groups
      set_fact:
        servers_in_unused_groups: "{{ (servers_in_unused_groups | default([])) | unique | list }}"

    # ----- Your vars file mapping (adjust key here if needed)
    # Expect either:
    #   radius_servers:
    #     - name: SLRMDCISEPSN01
    #       ip: 10.12.1.37
    #   OR radius_servers: [SLRMDCISEPSN01, SLPSOCISEPSN02, ...]
    - name: Normalize managed radius server names from vars
      set_fact:
        managed_radius_names: >-
          {{
            (
              (radius_servers | default([]))
              if ((radius_servers | default([])) | length > 0 and (radius_servers[0] is string))
              else
              ((radius_servers | default([])) | map(attribute='name') | select('defined') | list)
            )
            | map('string')
            | unique
            | list
          }}

    - name: Find configured radius server objects (radius server NAME)
      set_fact:
        radius_servers_configured: "{{ (run_text | regex_findall('(?m)^\\s*radius\\s+server\\s+(\\S+)\\b')) | unique | list }}"

    - name: Compute unused managed radius server objects (in unused groups)
      set_fact:
        unused_managed_radius_servers: >-
          {{
            (managed_radius_names | default([]))
            | intersect(radius_servers_configured | default([]))
            | intersect(servers_in_unused_groups | default([]))
            | unique
            | list
          }}

    # ------------------------------------------------------------
    # C) SHOW PLAN + APPLY
    # ------------------------------------------------------------

    - name: Show results
      debug:
        msg:
          aaa_method_lists: "{{ aaa_method_lists }}"
          used_outside_aaa: "{{ used_outside_aaa | default([]) }}"
          safe_to_remove_lists: "{{ safe_to_remove_lists }}"
          aaa_lines_to_remove: "{{ aaa_lines_to_remove | default([]) }}"
          radius_groups_configured: "{{ radius_groups_configured }}"
          radius_groups_referenced: "{{ radius_groups_referenced | default([]) }}"
          radius_groups_unused: "{{ radius_groups_unused }}"
          servers_in_unused_groups: "{{ servers_in_unused_groups | default([]) }}"
          managed_radius_names: "{{ managed_radius_names | default([]) }}"
          radius_servers_configured: "{{ radius_servers_configured }}"
          unused_managed_radius_servers: "{{ unused_managed_radius_servers }}"

    - name: Remove unused AAA method list lines (exact matches)
      ios_config:
        lines: "{{ aaa_lines_to_remove }}"
      when: (aaa_lines_to_remove | default([])) | length > 0

    - name: Remove unused RADIUS server-groups
      ios_config:
        lines: "{{ radius_groups_unused | map('regex_replace', '^(.*)$', 'no aaa group server radius \\1') | list }}"
      when: radius_groups_unused | length > 0

    - name: Remove unused managed radius server objects
      ios_config:
        lines: "{{ unused_managed_radius_servers | map('regex_replace', '^(.*)$', 'no radius server \\1') | list }}"
      when: unused_managed_radius_servers | length > 0
