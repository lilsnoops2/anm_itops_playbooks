---
- name: Clean Up Radius Config
  hosts: all
  gather_facts: no
  connection: network_cli
  vars_files:
    - ./vars/aaa-servers.yml

  vars:    
    ansible_become_password: "{{ enable | default(ansible_password) }}"
    ansible_become: true
    ansible_become_method: enable
    ignore_method_lists:
      - default
      - console
      - "1"
      - "5"
      - "15"
      - newinfo


  pre_tasks:

    - name: Prompt for username
      pause:
        prompt: "Enter username"
        echo: yes
      register: user_input
      when: ansible_user is not defined
      delegate_to: localhost
      run_once: true

    - name: Prompt for password
      pause:
        prompt: "Enter password"
        echo: no
      register: pass_input
      when: ansible_password is not defined
      delegate_to: localhost
      run_once: true
    

    - name: Set username from prompt
      set_fact:
        ansible_user: "{{ user_input.user_input }}"
      when: user_input is defined and user_input.user_input is defined

    - name: Set password from prompt
      set_fact:
        ansible_password: "{{ pass_input.user_input }}"
      when: pass_input is defined and pass_input.user_input is defined


  tasks:
    # ------------------------------------------------------------
    # STEP 1: Unlink + delete RADIUS servers by IP using `show run aaa`
    # ------------------------------------------------------------

    - name: Get AAA running-config section (source of truth for radius/groups)
      ios_command:
        commands:
          - show run aaa
      register: aaa_run

    - name: Normalize AAA text
      set_fact:
        aaa_text: "{{ aaa_run.stdout[0] | replace('\r','') }}"
        aaa_lines: "{{ (aaa_run.stdout[0] | replace('\r','')).splitlines() }}"

    - name: Build allowed radius IP list from aaa-servers.yml
      set_fact:
        allowed_radius_ips: >-
          {{
            (radius_servers | default([]))
            | map(attribute='ip')
            | select('defined')
            | map('string')
            | unique
            | list
          }}

    - name: List configured radius server object names (from show run aaa)
      set_fact:
        radius_server_names_configured: >-
          {{
            (aaa_text | regex_findall('(?m)^\\s*radius\\s+server\\s+(\\S+)\\b'))
            | unique
            | list
          }}

    - name: Initialize working lists
      set_fact:
        configured_radius_map: []
        radius_unlink_lines: []

    - name: Build map of configured radius servers (name -> ip) from show run aaa
      set_fact:
        configured_radius_map: "{{ configured_radius_map + [ { 'name': item, 'ip': ip_found } ] }}"
      loop: "{{ radius_server_names_configured | default([]) }}"
      vars:
        esc_name: "{{ item | regex_replace('([\\\\.^$|()\\[\\]{}*+?\\\\-])', '\\\\\\1') }}"
        body: >-
          {{
            (aaa_text
              | regex_findall('(?ms)^\\s*radius\\s+server\\s+' ~ esc_name ~ '\\b\\s*\\n(.*?)(?=^\\S|\\Z)')
              | first
              | default('')
            )
          }}
        ip_found: >-
          {{
            (body
              | regex_findall('(?m)^\\s*address\\s+ipv4\\s+(\\d{1,3}(?:\\.\\d{1,3}){3})\\b')
              | first
              | default('')
            )
          }}

    - name: Drop radius server objects where IP could not be parsed
      set_fact:
        configured_radius_map: "{{ (configured_radius_map | default([])) | rejectattr('ip', 'equalto', '') | list }}"

    - name: Compute radius servers to remove (IP not in aaa-servers.yml)
      set_fact:
        radius_servers_to_remove: >-
          {{
            (configured_radius_map | default([]))
            | rejectattr('ip', 'in', allowed_radius_ips | default([]))
            | list
          }}

    - name: Compute derived removal lists (names and IPs)
      set_fact:
        radius_names_to_remove: "{{ (radius_servers_to_remove | default([])) | map(attribute='name') | unique | list }}"
        radius_ips_to_remove: "{{ (radius_servers_to_remove | default([])) | map(attribute='ip') | unique | list }}"


    - name: Find configured RADIUS group names (from show run aaa)
      set_fact:
        radius_groups_configured: >-
          {{
            (aaa_text | regex_findall('(?m)^\\s*aaa\\s+group\\s+server\\s+radius\\s+(\\S+)\\b'))
            | unique
            | list
          }}

    - name: Build unlink lines (remove bad server names from groups)
      set_fact:
        radius_unlink_lines: "{{ radius_unlink_lines + unlink_cmds }}"
      loop: "{{ radius_groups_configured | default([]) }}"
      vars:
        group_name: "{{ item }}"
        esc_group: "{{ group_name | regex_replace('([\\\\.^$|()\\[\\]{}*+?\\\\-])', '\\\\\\1') }}"
        group_body: >-
          {{
            (aaa_text
              | regex_findall('(?ms)^\\s*aaa\\s+group\\s+server\\s+radius\\s+' ~ esc_group ~ '\\b\\s*\\n(.*?)(?=^\\S|\\Z)')
              | first
              | default('')
            )
          }}
        servers_in_group: "{{ group_body | regex_findall('(?m)^\\s*server\\s+name\\s+(\\S+)\\b') | unique | list }}"
        bad_servers_in_group: "{{ servers_in_group | intersect(radius_names_to_remove | default([])) }}"
        unlink_cmds: >-
          {{
            (
              ['aaa group server radius ' ~ group_name]
              +
              (bad_servers_in_group | map('regex_replace', '^(.*)$', 'no server name \\1') | list)
            )
            if (bad_servers_in_group | length > 0)
            else
            []
          }}

    - name: Show RADIUS unlink/delete plan
      debug:
        msg:
          allowed_radius_ips: "{{ allowed_radius_ips }}"
          configured_radius_map: "{{ configured_radius_map }}"
          radius_ips_to_remove: "{{ radius_ips_to_remove }}"
          radius_names_to_remove: "{{ radius_names_to_remove }}"
          radius_unlink_lines: "{{ radius_unlink_lines }}"

    - name: Unlink bad RADIUS servers from groups
      ios_config:
        lines: "{{ radius_unlink_lines }}"
      when:
        - allowed_radius_ips | length > 0
        - radius_unlink_lines | length > 0

    - name: Delete bad radius server objects (by NAME; selected by IP)
      ios_config:
        lines: "{{ radius_names_to_remove | map('regex_replace', '^(.*)$', 'no radius server \\1') | list }}"
      when:
        - allowed_radius_ips | length > 0
        - radius_names_to_remove | length > 0
