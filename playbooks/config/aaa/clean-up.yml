---
- name: Clean Up Radius Config
  hosts: all
  gather_facts: no
  connection: network_cli
  vars_files:
    - "{{ playbook_dir }}/vars/aaa-servers.yml"


  vars:    
    ansible_become_password: "{{ enable | default(ansible_password) }}"
    ansible_become: true
    ansible_become_method: enable
    tacacs_key: ""
    radius_key: ""
    ignore_method_lists:
      - default
      - console
      - "1"
      - "5"
      - "15"
      - newinfo


  pre_tasks:

    - name: Fail if aaa-servers.yml did not load
      fail:
        msg: "aaa-servers.yml did not load. Check vars_files path: {{ playbook_dir }}/vars/aaa-servers.yml"
      when: radius_servers is not defined or (radius_servers | length) == 0

    - name: Prompt for username
      pause:
        prompt: "Enter username"
        echo: yes
      register: user_input
      when: ansible_user is not defined
      delegate_to: localhost
      run_once: true

    - name: Prompt for password
      pause:
        prompt: "Enter password"
        echo: no
      register: pass_input
      when: ansible_password is not defined
      delegate_to: localhost
      run_once: true
    

    - name: Set username from prompt
      set_fact:
        ansible_user: "{{ user_input.user_input }}"
      when: user_input is defined and user_input.user_input is defined

    - name: Set password from prompt
      set_fact:
        ansible_password: "{{ pass_input.user_input }}"
      when: pass_input is defined and pass_input.user_input is defined

  tasks:

    # ------------------------------------------------------------
    # Collect RADIUS-related config safely
    # ------------------------------------------------------------

    - name: Collect RADIUS server objects and group blocks
      ios_command:
        commands:
          - "show running-config | section ^radius server"
          - "show running-config | section ^aaa group server radius"
      register: rad_collect

    - name: Normalize RADIUS config text
      set_fact:
        radius_obj_text: "{{ rad_collect.stdout[0] | default('') | replace('\r', '\n') }}"
        radius_group_text: "{{ rad_collect.stdout[1] | default('') | replace('\r', '\n') }}"

    # ------------------------------------------------------------
    # Build allowed RADIUS IP list from aaa-servers.yml
    # ------------------------------------------------------------

    - name: Build allowed radius IP list from vars file
      set_fact:
        allowed_radius_ips: >-
          {{
            (radius_servers | default([]))
            | map(attribute='ip')
            | select('defined')
            | map('string')
            | unique
            | list
          }}

    # ------------------------------------------------------------
    # Convert raw output into clean line lists
    # ------------------------------------------------------------

    - name: Convert radius config output to clean lines
      set_fact:
        radius_obj_lines: >-
          {{
            radius_obj_text.split('\n')
            | map('trim')
            | reject('equalto', '')
            | list
          }}
        radius_group_lines: >-
          {{
            radius_group_text.split('\n')
            | map('trim')
            | reject('equalto', '')
            | list
          }}

    # ------------------------------------------------------------
    # Parse RADIUS server objects (name + IP) — line-based
    # ------------------------------------------------------------

    - name: Initialize radius parsing state
      set_fact:
        configured_radius_map: []
        _cur_radius_name: ""
        _cur_radius_ip: ""

    - name: Parse radius server objects from lines
      set_fact:
        configured_radius_map: >-
          {{
            configured_radius_map
            + (
                [ {'name': _cur_radius_name, 'ip': _cur_radius_ip} ]
                if (new_server and _cur_radius_name != "" and _cur_radius_ip != "")
                else []
              )
          }}
        _cur_radius_name: "{{ line.split()[2] if new_server else _cur_radius_name }}"
        _cur_radius_ip: "{{ line.split()[2] if is_address else _cur_radius_ip }}"
      loop: "{{ radius_obj_lines }}"
      loop_control:
        loop_var: line
      vars:
        new_server: "{{ line.startswith('radius server ') }}"
        is_address: "{{ line.startswith('address ipv4 ') }}"

    - name: Flush last parsed radius server
      set_fact:
        configured_radius_map: >-
          {{
            configured_radius_map
            + (
                [ {'name': _cur_radius_name, 'ip': _cur_radius_ip} ]
                if (_cur_radius_name != "" and _cur_radius_ip != "")
                else []
              )
          }}

    - name: Normalize configured radius map
      set_fact:
        configured_radius_map: "{{ configured_radius_map | unique | list }}"

    # ------------------------------------------------------------
    # Parse RADIUS groups and members — line-based
    # ------------------------------------------------------------

    - name: Initialize group parsing state
      set_fact:
        radius_groups_configured: []
        group_members: {}
        _cur_group: ""

    - name: Parse radius groups and members
      set_fact:
        radius_groups_configured: >-
          {{
            radius_groups_configured
            + ([ line.split()[-1] ] if line.startswith('aaa group server radius ') else [])
          }}
        _cur_group: >-
          {{
            line.split()[-1] if line.startswith('aaa group server radius ') else _cur_group
          }}
        group_members: >-
          {{
            group_members
            | combine(
                (
                  {
                    _cur_group:
                      (group_members.get(_cur_group, []) + [ line.split()[-1] ]) | unique
                  }
                  if (line.startswith('server name ') and _cur_group != "")
                  else {}
                ),
                recursive=True
              )
          }}
      loop: "{{ radius_group_lines }}"
      loop_control:
        loop_var: line

    - name: Normalize radius group list
      set_fact:
        radius_groups_configured: "{{ radius_groups_configured | unique | list }}"

    # ------------------------------------------------------------
    # Determine which RADIUS servers must be removed (by IP)
    # ------------------------------------------------------------

    - name: Compute radius servers to remove (IP not in vars)
      set_fact:
        radius_servers_to_remove: >-
          {{
            configured_radius_map
            | rejectattr('ip', 'in', allowed_radius_ips)
            | list
          }}

    - name: Compute derived removal lists
      set_fact:
        radius_names_to_remove: "{{ radius_servers_to_remove | map(attribute='name') | unique | list }}"
        radius_ips_to_remove: "{{ radius_servers_to_remove | map(attribute='ip') | unique | list }}"

    # ------------------------------------------------------------
    # Build unlink commands (remove bad servers from groups FIRST)
    # ------------------------------------------------------------

    - name: Build unlink commands for radius groups
      set_fact:
        radius_unlink_lines: "{{ radius_unlink_lines | default([]) + unlink_cmds }}"
      loop: "{{ radius_groups_configured }}"
      loop_control:
        loop_var: grp
      vars:
        bad_servers_in_group: "{{ group_members.get(grp, []) | intersect(radius_names_to_remove) }}"
        unlink_cmds: >-
          {{
            (
              ['aaa group server radius ' ~ grp]
              +
              (bad_servers_in_group | map('regex_replace', '^(.*)$', 'no server name \\1') | list)
            )
            if (bad_servers_in_group | length > 0)
            else []
          }}

    # ------------------------------------------------------------
    # SHOW PLAN (NO CHANGES YET)
    # ------------------------------------------------------------

    - name: Show RADIUS unlink/delete plan
      debug:
        msg:
          allowed_radius_ips: "{{ allowed_radius_ips }}"
          configured_radius_map: "{{ configured_radius_map }}"
          radius_ips_to_remove: "{{ radius_ips_to_remove }}"
          radius_names_to_remove: "{{ radius_names_to_remove }}"
          group_members: "{{ group_members }}"
          radius_unlink_lines: "{{ radius_unlink_lines | default([]) }}"

    # ------------------------------------------------------------
    # APPLY CHANGES
    # ------------------------------------------------------------

    - name: Unlink bad RADIUS servers from groups
      ios_config:
        lines: "{{ radius_unlink_lines }}"
      when:
        - radius_unlink_lines is defined
        - radius_unlink_lines | length > 0

    - name: Delete bad RADIUS server objects
      ios_config:
        lines: "{{ radius_names_to_remove | map('regex_replace', '^(.*)$', 'no radius server \\1') | list }}"
      when:
        - radius_names_to_remove | length > 0
