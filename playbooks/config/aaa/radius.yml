#ansible-playbook playbooks/configuration/aaa/radius.yml -l 'c9200l' -e 'organization_prefix=ANM' -e 'ansible_user=user' -e 'ansible_password=password' -e 'tacacs_key=tacacs123' -e 'conf_coa=yes' -e 'deadtime=10' -e 'timeout_seconds=3' -e 'retry=3'
---
- name: Standardize radius configuration with named method lists
  hosts: all
  gather_facts: no
  connection: network_cli
  vars_files:
    - ./vars/aaa-servers.yml

  vars:
    organization_prefix: "{{ org_prefix | upper | default('') }}"
    prompt_for_prefix: "{{ organization_prefix == '' }}"
    radius_group_name: "{{ group_name | default(organization_prefix ~ '-RADIUS') }}"  
    auth_method_list: "{{ organization_prefix | lower }}-authc-radius"
    authz_method_list: "{{ organization_prefix | lower }}-authz-radius"
    ansible_become_password: "{{ enable | default(ansible_password) }}"
    ansible_become: true
    ansible_become_method: enable
    lb: "{{ load_balance | default('no') }}"
    conf_tester: "{{ config_tester | default('no') }}"
    conf_avp: "{{ config_avp | default('no') }}"
    conf_coa: "{{ config_coa | default('no') }}"
    conf_login: "{{ config_login | default('no') }}"
    login_o: "{{ login_only | default('no') }}"
    conf_device_sensor: "{{ config_device_sensor | default('no') }}"
    cleanup_radius: "{{ cleanup | default('no') }}"


  pre_tasks:

    - name: Prompt for username
      pause:
        prompt: "Enter username"
        echo: yes
      register: user_input
      when: ansible_user is not defined
      delegate_to: localhost
      run_once: true

    - name: Prompt for password
      pause:
        prompt: "Enter password"
        echo: no
      register: pass_input
      when: ansible_password is not defined
      delegate_to: localhost
      run_once: true
    
    - name: Prompt for organization prefix
      run_once: true
      delegate_to: localhost
      pause:
        prompt: "Enter your organization prefix (e.g., ANM, MST, LAB): "
      register: org_prefix_input
      when: prompt_for_prefix

    - name: Prompt for radius shared secret key
      pause:
        prompt: "Enter radius shared secret key (will not echo):"
        echo: no
      register: radius_key_prompt
      when: radius_key is not defined
      delegate_to: localhost
      run_once: true

    - name: Set username from prompt
      set_fact:
        ansible_user: "{{ user_input.user_input }}"
      when: user_input is defined and user_input.user_input is defined

    - name: Set password from prompt
      set_fact:
        ansible_password: "{{ pass_input.user_input }}"
      when: pass_input is defined and pass_input.user_input is defined

    - name: Set organization prefix from prompt
      set_fact:
        organization_prefix: "{{ org_prefix_input.user_input | upper }}"
      when: prompt_for_prefix

    - name: Update naming convention variables
      set_fact:
        radius_group_name: "{{ organization_prefix }}-RADIUS"
        auth_method_list: "{{ organization_prefix | lower }}-authc-radius"
        authz_method_list: "{{ organization_prefix | lower }}-authz-radius"

    - name: Set radius key variable
      set_fact:
        radius_key: "{{ radius_key_prompt.user_input }}"
      when: radius_key is not defined

    - name: Ensure AAA new-model is enabled
      ios_config:
        lines:
          - "aaa new-model"
        match: exact
      when: ansible_network_os in ['ios', 'iosxe']

  tasks:
    ##########################################################
    # 1. Gather existing radius configuration
    ##########################################################

    - name: Gather current named radius servers
      tags: cleanup
      ios_command:
        commands:
          - "show running-config | section ^radius server"
      register: radius_config

    ##########################################################
    # 2. Configure named radius servers
    ##########################################################

    - name: Initialize RADIUS server facts
      tags: cleanup
      set_fact:
        existing_radius_map: {}
        existing_radius_keys: {}

    - name: Parse radius servers line-by-line
      tags: cleanup
      vars:
        config_lines: "{{ radius_config.stdout[0].splitlines() }}"
      block:
        - name: Loop through config lines
          set_fact:
            existing_radius_map: >-
              {{
                (line.startswith('radius server') and
                 existing_radius_map.update({line.split()[2]: (config_lines[config_lines.index(line)+1].split()[2] if 'address ipv4' in config_lines[config_lines.index(line)+1] else None)}) or existing_radius_map)
              }}
            existing_radius_keys: >-
              {{
                (line.startswith('radius server') and
                 (config_lines[config_lines.index(line)+2].split(None,1)[1] if 'key ' in config_lines[config_lines.index(line)+2] else None)
                 is not none and
                 existing_radius_keys.update({line.split()[2]: config_lines[config_lines.index(line)+2].split(None,1)[1]}) or existing_radius_keys)
              }}
          loop: "{{ config_lines }}"
          loop_control:
            label: "hidden"
            loop_var: line
          no_log: true

    - name: Build list of currently configured radius IPs
      set_fact:
        existing_radius_ips: "{{ existing_radius_map.values() | list }}"

    - name: Build servers_with_names (loop-based)
      set_fact:
        servers_with_names: []

    - name: Append server_name to each required server
      set_fact:
        servers_with_names: >-
          {{
            servers_with_names + [server | combine({'server_name': (existing_radius_map | dict2items | selectattr('value','equalto', server.ip) | map(attribute='key') | list | first) | default(server.name) })]
          }}
      loop: "{{ radius_servers }}"
      loop_control:
        label: "hidden"
        loop_var: server
      no_log: true

    - name: Add or update RADIUS servers (reuse existing key if present)
      ios_config:
        parents: "radius server {{ server.server_name }}"
        lines:
          - "address ipv4 {{ server.ip }}"
          - "{{ 'key ' ~ existing_radius_keys[server.server_name] if server.server_name in existing_radius_keys else 'key ' ~ (server.key | default(radius_key)) }}"
      loop: "{{ servers_with_names }}"
      loop_control:
        label: "hidden"
        loop_var: server
      no_log: true


    - name: Configure radius server group
      ios_config:
        parents: "aaa group server radius {{ radius_group_name }}"
        lines: "{{ servers_with_names | map(attribute='server_name') | map('regex_replace', '^(.*)$', 'server name \\1') | list }}"



    ##########################################################
    # 3. Configure optional
    ##########################################################
    - name: Add automate-tester line under each RADIUS server
      when: 
        - ansible_network_os in ['ios', 'iosxe']
        - conf_tester == 'yes'
      ios_config:
        lines:
          - "automate-tester username radius-test idle-time 10"
        parents: "radius server {{ server.server_name }}"
      loop: "{{ servers_with_names }}"
      loop_control:
        loop_var: server
      no_log: true

    - name: Add or update COA servers
      when: conf_coa == "yes"
      ios_config:
        parents: "aaa server radius dynamic-author"
        lines:
          - "client {{ server.ip }} server-key {{ server.key }}"
      loop: "{{ servers_with_names }}"
      loop_control:
        label: "Hidden"
        loop_var: server
      no_log: true

    - name: Set RADIUS Access request AVP
      when: 
        - ansible_network_os in ['ios', 'iosxe']
        - conf_avp == 'yes'
      ios_config:
        lines:
          - "radius-server attribute 6 on-for-login-auth"
          - "radius-server attribute 8 include-in-access-req"
          - "radius-server attribute 25 access-request include"
          - "radius-server attribute 31 mac format ietf"
          - "radius-server attribute 31 send nas-port-detail"
        match: exact
      ignore_errors: true


    - name: Enable Device Sensor
      when: 
        - ansible_network_os in ['ios', 'iosxe']
        - conf_device_sensor == 'yes'
      ios_config:
        lines:
          - "device-sensor notify all-changes"
          - "device-sensor accounting"
        match: exact
      ignore_errors: true


    ##########################################################
    # 4. Enforce AAA baseline configuration
    ##########################################################
    - name: Enforce AAA global settings - no load-balance
      ios_config:
        lines:
          - "radius-server dead-criteria time {{ timeout_seconds | default(3) }} tries {{ retry | default(3) }}"
          - "radius-server retransmit {{ retry | default(3) }}"
          - "radius-server timeout {{ timeout_seconds | default(3) }}"
          - "radius-server deadtime {{ deadtime | default(10) }}"
          - "no radius-server load-balance method least-outstanding"
        match: exact
      ignore_errors: true
      when: 
       - ansible_network_os in ['ios', 'iosxe']
       - lb == "no"

    - name: Enforce AAA global settings - load-balance
      ios_config:
        lines:
          - "radius-server dead-criteria time {{ timeout_seconds | default(3) }} tries {{ retry | default(3) }}"
          - "radius-server retransmit {{ retry | default(3) }}"
          - "radius-server timeout {{ timeout_seconds | default(3) }}"
          - "radius-server deadtime {{ deadtime | default(10) }}"
          - "radius-server load-balance method least-outstanding"
        match: exact
      ignore_errors: true
      when: 
       - ansible_network_os in ['ios', 'iosxe']
       - lb == "yes"


    - name: Enforce AAA authentication/authorization/accounting - dot1x/mab/login
      ios_config:
        lines:
          - "aaa authentication dot1x default group {{ radius_group_name }}"
          - "aaa authorization network default group {{ radius_group_name }}"
          - "aaa authentication login {{ auth_method_list }} group {{ radius_group_name }} local enable"
          - "aaa authentication enable default group {{ radius_group_name }} enable"
          - "aaa authorization exec {{ authz_method_list }} group {{ radius_group_name }} local if-authenticated"
          - "aaa accounting commands 1 default start-stop group {{ radius_group_name }}"
          - "aaa accounting commands 15 default start-stop group {{ radius_group_name }}"
          - "aaa accounting network default start-stop group {{ radius_group_name }}"
          - "aaa accounting system default start-stop group {{ radius_group_name }}"
          - "aaa accounting auth-proxy default start-stop group {{ radius_group_name }}"
          - "aaa accounting dot1x default start-stop group {{ radius_group_name }}"
          - "aaa accounting update newinfo periodic 2880"
        match: exact
      when: 
       - ansible_network_os in ['ios', 'iosxe']
       - conf_login == "yes"


    - name: Enforce AAA authentication/authorization/accounting - login only
      ios_config:
        lines:
          - "aaa authentication login {{ auth_method_list }} group {{ radius_group_name }} local enable"
          - "aaa authentication enable default group {{ radius_group_name }} enable"
          - "aaa authorization exec {{ authz_method_list }} group {{ radius_group_name }} local if-authenticated"
          - "aaa accounting commands 1 default start-stop group {{ radius_group_name }}"
          - "aaa accounting commands 5 default start-stop group {{ radius_group_name }}"
          - "aaa accounting commands 15 default start-stop group {{ radius_group_name }}"
        match: exact
      when: 
       - ansible_network_os in ['ios', 'iosxe']
       - login_o == "yes"

    - name: Enforce AAA authentication/authorization/accounting  - dot1x/mab only
      ios_config:
        lines:
          - "aaa authentication dot1x default group {{ radius_group_name }}"
          - "aaa authorization network default group {{ radius_group_name }}"
          - "aaa accounting network default start-stop group {{ radius_group_name }}"
          - "aaa accounting system default start-stop group {{ radius_group_name }}"
          - "aaa accounting auth-proxy default start-stop group {{ radius_group_name }}"
          - "aaa accounting dot1x default start-stop group {{ radius_group_name }}"
          - "aaa accounting update newinfo periodic 2880"
        match: exact
      when: 
       - ansible_network_os in ['ios', 'iosxe']

    ##########################################################
    # 5. Configure VTY line authentication
    ##########################################################
    - name: Get available VTY lines
      ios_command:
        commands:
          - "show running-config | section line vty"
      register: vty_lines_output
      when: 
        - ansible_network_os in ['ios', 'iosxe']
        - login_o == "yes" or conf_login == "yes"

    - name: Parse VTY line ranges (e.g., 0 4, 5 15, 0 31)
      set_fact:
        vty_groups: "{{ vty_lines_output.stdout[0] | regex_findall('line vty (\\d+)\\s+(\\d+)') | map('map', 'int') | list }}"
      when: 
        - ansible_network_os in ['ios', 'iosxe']
        - login_o == "yes" or conf_login == "yes"

    - name: Configure VTY line login and authorization ranges
      ios_config:
        parents: "line vty {{ item.0 }} {{ item.1 }}"
        lines:
          - "login authentication {{ auth_method_list }}"
          - "authorization exec {{ authz_method_list }}"
        match: line
      loop: "{{ vty_groups }}"
      loop_control:
        label: "hidden"
      when: 
        - ansible_network_os in ['ios', 'iosxe']
        - login_o == "yes" or conf_login == "yes"
      no_log: true

  

    ##########################################################
    # 6. Save and verify
    ##########################################################
    - name: Save running configuration
      ios_command:
        commands:
          - "write memory"
      when: ansible_network_os in ['ios', 'iosxe']
      vars:
        ansible_command_timeout: 120
        ansible_connect_timeout: 120

    - name: Test AAA Group
      tags: validate
      ios_command:
        commands:
          - "test aaa group {{ radius_group_name }} {{ ansible_user }} {{ ansible_password }} new-code"
        wait_for:
          - result[0] contains successfully
      register: radius_test
      when: ansible_network_os in ['ios', 'iosxe']
      vars:
        ansible_command_timeout: 120
        ansible_connect_timeout: 120


    - name: Verify radius and AAA configuration
      tags: validate
      ios_command:
        commands:
          - "show running-config | section aaa"
          - "show running-config | section line vty"
      register: verify_config
      when: ansible_network_os in ['ios', 'iosxe']

    - name: Display verification summary
      tags: validate
      debug:
        msg: |
          Radius Configuration Verified
          --------------------------------
          Group: {{ radius_group_name | default('N/A') }}
          Authentication: {{ auth_method_list | default('N/A') }}
          Authorization: {{ authz_method_list | default('N/A')  }}
          Test: {{ radius_test | default('Failed') }}

          --- AAA Section ---
          {{ verify_config.stdout[0] | default('N/A') }}

          --- VTY Lines Section ---
          {{ verify_config.stdout[1] | default('N/A') }}

    ##########################################################
    # clean-up
    # Remove extra & stale RADIUS servers and group entries
    ##########################################################

    - block:

        ##########################################################
        # Init
        ##########################################################

        - name: clean-up | Initialize cleanup facts
          set_fact:
            radius_unlink_lines: []
            group_members: {}
            _cur_grp: ""

        ##########################################################
        # 1) Allowed IPs from aaa-servers.yml
        ##########################################################

        - name: clean-up | Build allowed radius IP list
          set_fact:
            allowed_radius_ips: >-
              {{
                (radius_servers | default([]))
                | map(attribute='ip')
                | select('defined')
                | map('string')
                | unique
                | list
              }}

        ##########################################################
        # 2) Extra configured servers (exist but not allowed)
        ##########################################################

        - name: clean-up | Compute extra configured radius servers
          set_fact:
            radius_names_to_remove: >-
              {{
                (existing_radius_map | default({}) | dict2items)
                | rejectattr('value', 'in', allowed_radius_ips)
                | map(attribute='key')
                | list
              }}
            radius_ips_to_remove: >-
              {{
                (existing_radius_map | default({}) | dict2items)
                | rejectattr('value', 'in', allowed_radius_ips)
                | map(attribute='value')
                | list
              }}

        ##########################################################
        # 3) Gather radius groups (raw text)
        ##########################################################

        - name: clean-up | Gather radius groups
          ios_command:
            commands:
              - "show running-config | section aaa group server radius"
          register: cleanup_radius_groups

        ##########################################################
        # 4) Parse group members (line-based, safe)
        ##########################################################

        - name: clean-up | Parse group members
          set_fact:
            _cur_grp: "{{ line.split()[-1] if line.startswith('aaa group server radius ') else _cur_grp }}"
            group_members: >-
              {{
                group_members
                | combine(
                    (
                      { _cur_grp: ((group_members.get(_cur_grp, []) + [line.split()[-1]]) | unique) }
                      if (line.startswith('server name ') and _cur_grp != '')
                      else {}
                    ),
                    recursive=True
                  )
              }}
          loop: "{{ (cleanup_radius_groups.stdout[0] | default('')).splitlines() | map('trim') | list }}"
          loop_control:
            loop_var: line
            label: "hidden"

        - name: clean-up | Build group list
          set_fact:
            radius_groups_configured: "{{ group_members.keys() | list }}"

        ##########################################################
        # 5) Desired server names (from allowed IPs)
        ##########################################################

        - name: clean-up | Compute desired radius server names
          set_fact:
            desired_radius_names: >-
              {{
                (existing_radius_map | default({}) | dict2items)
                | selectattr('value', 'in', allowed_radius_ips)
                | map(attribute='key')
                | list
              }}

        ##########################################################
        # 6) Stale group-only members
        #    (in group, not desired, and no radius server object)
        ##########################################################

        - name: clean-up | Compute stale group members
          set_fact:
            stale_group_members: >-
              {{
                (
                  group_members.values() | list | flatten | unique
                )
                | difference(desired_radius_names | default([]))
                | difference((existing_radius_map | default({})).keys() | list)
              }}

        ##########################################################
        # 7) Build unlink commands (extra + stale)
        ##########################################################

        # - name: clean-up | Append unlink commands per group (zero regex)
        #   set_fact:
        #     radius_unlink_lines: "{{ radius_unlink_lines + ['aaa group server radius ' ~ grp] + (bad_in_group | map('string') | map('regex_replace', '^', 'no server name ') | list) }}"
        #   loop: "{{ radius_groups_configured | default([]) }}"
        #   loop_control:
        #     loop_var: grp
        #   vars:
        #     members: "{{ group_members.get(grp, []) | default([]) }}"
        #     bad_in_group: "{{ members | intersect((radius_names_to_remove|default([])) + (stale_group_members|default([]))) | unique | list }}"
        #   when: bad_in_group | length > 0
          
        - name: clean-up | Build unlink ops (parents + lines)
          set_fact:
            radius_unlink_ops: "{{ (radius_unlink_ops | default([])) + ([{'parent': 'aaa group server radius ' ~ grp, 'lines': bad_lines}] if (bad_lines | length > 0) else []) }}"
          loop: "{{ radius_groups_configured | default([]) }}"
          loop_control:
            loop_var: grp
          vars:
            members: "{{ group_members.get(grp, []) | default([]) }}"
            bad_in_group: >-
              {{
                members
                | intersect((radius_names_to_remove | default([])) + (stale_group_members | default([])))
                | unique
                | list
              }}
            bad_lines: "{{ bad_in_group | map('regex_replace', '^', 'no server name ') | list }}"

        - name: clean-up | Show unlink ops plan
          debug:
            var: radius_unlink_ops



        ##########################################################
        # 8) Show plan
        ##########################################################

        - name: clean-up | Show unlink/delete plan
          debug:
            msg:
              allowed_radius_ips: "{{ allowed_radius_ips }}"
              existing_radius_map: "{{ existing_radius_map }}"
              desired_radius_names: "{{ desired_radius_names }}"
              radius_names_to_remove: "{{ radius_names_to_remove }}"
              stale_group_members: "{{ stale_group_members }}"
              group_members: "{{ group_members }}"
              radius_unlink_lines: "{{ radius_unlink_lines }}"

        ##########################################################
        # 9) APPLY: unlink first, then delete
        ##########################################################

        - name: clean-up | Unlink extra & stale servers from groups
          ios_config:
            parents: "{{ item.parent }}"
            lines: "{{ item.lines }}"
          loop: "{{ radius_unlink_ops | default([]) }}"
          loop_control:
            label: "{{ item.parent }}"
          when: (radius_unlink_ops | default([])) | length > 0


        - name: clean-up | Delete extra radius server objects
          ios_config:
            lines: "{{ radius_names_to_remove | map('regex_replace', '^(.*)$', 'no radius server \\1') | list }}"
          when: (radius_names_to_remove | length) > 0

        ##########################################################
        # 10) Clean Up Stale groups
        ##########################################################
        - name: clean-up | Re-gather radius groups after changes
          ios_command:
            commands:
              - "show running-config | section aaa group server radius"
          register: cleanup_radius_groups_after

        - name: clean-up | Compute empty radius groups (no server name entries)
          set_fact:
            empty_radius_groups: []
            _cur_grp: ""
            _cur_has_member: false

        - name: clean-up | Scan groups and detect empties
          set_fact:
            # when we hit a new group header, finalize the previous group:
            empty_radius_groups: >-
              {{
                empty_radius_groups
                + ([ _cur_grp ] if (_cur_grp != '' and (not _cur_has_member)) else [])
                if (line.startswith('aaa group server radius '))
                else empty_radius_groups
              }}
            _cur_grp: "{{ (line.split()[-1]) if line.startswith('aaa group server radius ') else _cur_grp }}"
            _cur_has_member: "{{ true if line.startswith('server name ') else _cur_has_member }}"
          loop: "{{ (cleanup_radius_groups_after.stdout[0] | default('')).splitlines() | map('trim') | list }}"
          loop_control:
            loop_var: line
            label: "hidden"

        - name: clean-up | Finalize last group empty check
          set_fact:
            empty_radius_groups: "{{ empty_radius_groups + ([ _cur_grp ] if (_cur_grp != '' and (not _cur_has_member)) else []) }}"

        - name: clean-up | Remove empty radius groups
          ios_config:
            lines: "{{ empty_radius_groups | map('regex_replace', '^(.*)$', 'no aaa group server radius \\1') | list }}"
          when: (empty_radius_groups | default([])) | length > 0

        - name: clean-up | Show empty groups removed
          debug:
            msg:
              empty_radius_groups: "{{ empty_radius_groups | default([]) }}"

        ##########################################################
        # 11) Remove Unused/Stale AAA Method lists
        ##########################################################
        - name: clean-up | Gather AAA server groups after cleanup (radius + tacacs)
          ios_command:
            commands:
              - "show running-config | section aaa group server"
          register: aaa_groups_after

        - name: clean-up | Build list of existing AAA groups after cleanup (all types)
          set_fact:
            aaa_groups_existing_after: >-
              {{
                (aaa_groups_after.stdout[0] | default('')).splitlines()
                | map('trim')
                | select('match', '^aaa group server ')
                | map('split')
                | map('last')
                | unique
                | list
              }}

        - name: clean-up | Gather AAA section after cleanup
          ios_command:
            commands:
              - "show running-config | section aaa"
          register: aaa_after

        - name: clean-up | Collect AAA METHOD lines that reference a group (exclude aaa group server)
          set_fact:
            aaa_group_lines: >-
              {{
                (aaa_after.stdout[0] | default('')).splitlines()
                | map('trim')
                | select('match', '^aaa (authentication|authorization|accounting) ')
                | select('search', ' group ')
                | list
              }}


        - name: clean-up | Compute AAA lines to remove (group missing)
          set_fact:
            aaa_lines_to_remove: "{{ (aaa_lines_to_remove | default([])) + ([line] if remove_me else []) }}"
          loop: "{{ aaa_group_lines | default([]) }}"
          loop_control:
            loop_var: line
            label: "hidden"
          vars:
            grp: "{{ (line | regex_findall('\\bgroup\\s+(\\S+)') | first | default('')) }}"
            remove_me: >-
              {{
                (grp | length > 0)
                and (grp not in (aaa_groups_existing_after | default([])))
                and (not line.startswith('aaa group server '))
              }}

        - name: clean-up | Show AAA lines to remove (missing group)
          debug:
            msg:
              aaa_groups_existing_after: "{{ aaa_groups_existing_after | default([]) }}"
              aaa_lines_to_remove: "{{ aaa_lines_to_remove | default([]) }}"

        - name: clean-up | Remove AAA lines that reference missing groups
          ios_config:
            lines: "{{ aaa_lines_to_remove | default([]) | map('regex_replace', '^', 'no ') | list }}"
          when: (aaa_lines_to_remove | default([])) | length > 0


        ##########################################################
        # 11) Remove Stale CoA Clients
        ##########################################################

        - name: clean-up | Gather dynamic-author config
          ios_command:
            commands:
              - "show running-config | section ^aaa server radius dynamic-author"
          register: coa_cfg


        - name: clean-up | Debug COA raw text head
          debug:
            msg:
              coa_len: "{{ (coa_cfg.stdout[0] | default('')) | length }}"
              coa_head: "{{ (coa_cfg.stdout[0] | default(''))[:250] }}"

        - name: clean-up | Parse configured COA client IPs (robust)
          set_fact:
            coa_client_ips_configured: >-
              {{
                (
                  (coa_cfg.stdout[0] | default(''))
                  | regex_replace('\r', '')
                  | splitlines()
                  | map('trim')
                  | select('match', '^client\\s+\\d+\\.\\d+\\.\\d+\\.\\d+\\b')
                  | map('regex_findall', '^client\\s+(\\d+\\.\\d+\\.\\d+\\.\\d+)\\b')
                  | map('first')
                  | list
                )
                | unique
              }}


        - name: clean-up | Compute COA client IPs to remove (not in allowed_radius_ips)
          set_fact:
            coa_client_ips_to_remove: "{{ (coa_client_ips_configured | default([])) | difference(allowed_radius_ips | default([])) }}"

        - name: clean-up | Show COA cleanup plan
          debug:
            msg:
              allowed_radius_ips: "{{ allowed_radius_ips | default([]) }}"
              coa_client_ips_configured: "{{ coa_client_ips_configured | default([]) }}"
              coa_client_ips_to_remove: "{{ coa_client_ips_to_remove | default([]) }}"

        - name: clean-up | Remove stale dynamic-author clients
          ios_config:
            parents: "aaa server radius dynamic-author"
            lines: "{{ coa_client_ips_to_remove | map('regex_replace', '^(.*)$', 'no client \\1') | list }}"
          when: (coa_client_ips_to_remove | default([])) | length > 0


      tags:
        - cleanup
