---
- name: Clean Up Radius Config
  hosts: all
  gather_facts: no
  connection: network_cli
  vars_files:
    - "{{ playbook_dir }}/vars/aaa-servers.yml"


  vars:    
    ansible_become_password: "{{ enable | default(ansible_password) }}"
    ansible_become: true
    ansible_become_method: enable
    tacacs_key: ""
    radius_key: ""
    ignore_method_lists:
      - default
      - console
      - "1"
      - "5"
      - "15"
      - newinfo


  pre_tasks:

    - name: Fail if aaa-servers.yml did not load
      fail:
        msg: "aaa-servers.yml did not load. Check vars_files path: {{ playbook_dir }}/vars/aaa-servers.yml"
      when: radius_servers is not defined or (radius_servers | length) == 0

    - name: Prompt for username
      pause:
        prompt: "Enter username"
        echo: yes
      register: user_input
      when: ansible_user is not defined
      delegate_to: localhost
      run_once: true

    - name: Prompt for password
      pause:
        prompt: "Enter password"
        echo: no
      register: pass_input
      when: ansible_password is not defined
      delegate_to: localhost
      run_once: true
    

    - name: Set username from prompt
      set_fact:
        ansible_user: "{{ user_input.user_input }}"
      when: user_input is defined and user_input.user_input is defined

    - name: Set password from prompt
      set_fact:
        ansible_password: "{{ pass_input.user_input }}"
      when: pass_input is defined and pass_input.user_input is defined


  tasks:
    # ------------------------------------------------------------
    # STEP 1: Unlink + delete RADIUS servers by IP (hardened collection)
    # ------------------------------------------------------------

    - name: Build allowed radius IP list from aaa-servers.yml
      set_fact:
        allowed_radius_ips: >-
          {{
            (radius_servers | default([]))
            | map(attribute='ip')
            | select('defined')
            | map('string')
            | unique
            | list
          }}

    - name: Collect RADIUS server objects and group blocks using multiple commands
      ios_command:
        commands:
          # Radius server objects (try best -> fallback)
          - "show running-config | section ^radius server"
          - "show running-config | section radius server"
          - "show running-config | include ^radius server|address ipv4"

          # Radius groups (try best -> fallback)
          - "show running-config | section ^aaa group server radius"
          - "show running-config | section aaa group server radius"
          - "show running-config | include ^aaa group server radius|server name"
      register: rad_collect

    - name: Pick first non-empty radius object/group text
      set_fact:
        radius_obj_text: >-
          {{
            (
              [rad_collect.stdout[0], rad_collect.stdout[1], rad_collect.stdout[2]]
              | map('default', '')
              | map('replace', '\r', '')
              | map('string')
              | reject('equalto', '')
              | list
              | first
              | default('')
            )
          }}
        radius_group_text: >-
          {{
            (
              [rad_collect.stdout[3], rad_collect.stdout[4], rad_collect.stdout[5]]
              | map('default', '')
              | map('replace', '\r', '')
              | map('string')
              | reject('equalto', '')
              | list
              | first
              | default('')
            )
          }}


    - name: Debug command return lengths (so you can see which one worked)
      debug:
        msg:
          cmd0_len: "{{ (rad_collect.stdout[0] | default('')) | length }}"
          cmd1_len: "{{ (rad_collect.stdout[1] | default('')) | length }}"
          cmd2_len: "{{ (rad_collect.stdout[2] | default('')) | length }}"
          cmd3_len: "{{ (rad_collect.stdout[3] | default('')) | length }}"
          cmd4_len: "{{ (rad_collect.stdout[4] | default('')) | length }}"
          cmd5_len: "{{ (rad_collect.stdout[5] | default('')) | length }}"
          picked_radius_obj_len: "{{ radius_obj_text | length }}"
          picked_radius_group_len: "{{ radius_group_text | length }}"

    # ------------------------
    # Parse configured radius servers (name -> ip)
    # ------------------------

    - name: Extract configured radius server names (robust)
      set_fact:
        radius_server_names_configured: >-
          {{
            (radius_obj_text | regex_findall('(?:^|\\n)\\s*radius\\s+server\\s+(\\S+)\\b'))
            | unique
            | list
          }}


    - name: Initialize configured_radius_map
      set_fact:
        configured_radius_map: []

    - name: Build configured radius map (name -> ip) (supports both "section" and "include" output)
      set_fact:
        configured_radius_map: "{{ configured_radius_map + [ {'name': item, 'ip': ip_found} ] }}"
      loop: "{{ radius_server_names_configured }}"
      vars:
        esc_name: "{{ item | regex_replace('([\\\\.^$|()\\[\\]{}*+?\\\\-])', '\\\\\\1') }}"
        ip_found: >-
          {{
            (
              # If we have full blocks (section output), bind to this server until next radius server
              (radius_obj_text
                | regex_findall('(?ms)^\\s*radius\\s+server\\s+' ~ esc_name ~ '\\b.*?^\\s*address\\s+ipv4\\s+(\\d{1,3}(?:\\.\\d{1,3}){3})\\b.*?(?=^\\s*radius\\s+server\\s+|\\Z)'
              ) | first | default(''))
              # If the above fails (include output), just find first address line after the header line occurrence
              if (
                radius_obj_text is regex_search('(?ms)^\\s*radius\\s+server\\s+' ~ esc_name ~ '\\b.*?^\\s*address\\s+ipv4\\s+')
              )
              else
              (
                radius_obj_text
                | regex_findall('(?ms)^\\s*radius\\s+server\\s+' ~ esc_name ~ '\\b.*?address\\s+ipv4\\s+(\\d{1,3}(?:\\.\\d{1,3}){3})\\b'
                ) | first | default('')
              )
            )
          }}

    - name: Drop radius servers with no IP parsed
      set_fact:
        configured_radius_map: "{{ configured_radius_map | rejectattr('ip', 'equalto', '') | list }}"

    # ------------------------
    # Compute deletes (IP not allowed)
    # ------------------------

    - name: Compute radius servers to remove (IP not in aaa-servers.yml)
      set_fact:
        radius_servers_to_remove: >-
          {{
            configured_radius_map
            | rejectattr('ip', 'in', allowed_radius_ips)
            | list
          }}

    - name: Compute derived removal lists (names and IPs)
      set_fact:
        radius_names_to_remove: "{{ radius_servers_to_remove | map(attribute='name') | unique | list }}"
        radius_ips_to_remove: "{{ radius_servers_to_remove | map(attribute='ip') | unique | list }}"

    # ------------------------
    # Build unlink lines from groups first
    # ------------------------

    - name: Find configured RADIUS group names (robust)
      set_fact:
        radius_groups_configured: >-
          {{
            (radius_group_text | regex_findall('(?:^|\\n)\\s*aaa\\s+group\\s+server\\s+radius\\s+(\\S+)\\b'))
            | unique
            | list
          }}


    - name: Initialize unlink lines
      set_fact:
        radius_unlink_lines: []

    - name: Build unlink lines (remove bad server names from groups)
      set_fact:
        radius_unlink_lines: "{{ radius_unlink_lines + unlink_cmds }}"
      loop: "{{ radius_groups_configured }}"
      vars:
        group_name: "{{ item }}"
        esc_group: "{{ group_name | regex_replace('([\\\\.^$|()\\[\\]{}*+?\\\\-])', '\\\\\\1') }}"
        group_body: >-
          {{
            (radius_group_text
              | regex_findall('(?ms)^\\s*aaa\\s+group\\s+server\\s+radius\\s+' ~ esc_group ~ '\\b\\s*\\n(.*?)(?=^\\S|\\Z)')
              | first
              | default(radius_group_text)   # fallback if we only have include-style lines
            )
          }}
        servers_in_group: "{{ group_body | regex_findall('(?m)^\\s*server\\s+name\\s+(\\S+)\\b') | unique | list }}"
        bad_servers_in_group: "{{ servers_in_group | intersect(radius_names_to_remove) }}"
        unlink_cmds: >-
          {{
            (
              ['aaa group server radius ' ~ group_name]
              +
              (bad_servers_in_group | map('regex_replace', '^(.*)$', 'no server name \\1') | list)
            )
            if (bad_servers_in_group | length > 0)
            else
            []
          }}

    - name: Show RADIUS unlink/delete plan
      debug:
        msg:
          allowed_radius_ips: "{{ allowed_radius_ips }}"
          radius_server_names_configured: "{{ radius_server_names_configured }}"
          configured_radius_map: "{{ configured_radius_map }}"
          radius_ips_to_remove: "{{ radius_ips_to_remove }}"
          radius_names_to_remove: "{{ radius_names_to_remove }}"
          radius_groups_configured: "{{ radius_groups_configured }}"
          radius_unlink_lines: "{{ radius_unlink_lines }}"

    - name: Unlink bad RADIUS servers from groups
      ios_config:
        lines: "{{ radius_unlink_lines }}"
      when:
        - allowed_radius_ips | length > 0
        - radius_unlink_lines | length > 0

    - name: Delete bad radius server objects (by NAME; selected by IP)
      ios_config:
        lines: "{{ radius_names_to_remove | map('regex_replace', '^(.*)$', 'no radius server \\1') | list }}"
      when:
        - allowed_radius_ips | length > 0
        - radius_names_to_remove | length > 0
