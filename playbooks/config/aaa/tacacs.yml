#ansible-playbook playbooks/configuration/aaa/tacacs.yml -l 'c9200l' -e 'organization_prefix=ANM' -e 'ansible_user=user' -e 'ansible_password=password' -e 'tacacs_key=tacacs123'
---
- name: Standardize TACACS+ configuration with named method lists
  hosts: all
  gather_facts: no
  connection: network_cli
  vars_files:
    - ./vars/aaa-servers.yml

  vars:
    organization_prefix: "{{ org_prefix | upper | default('') }}"
    prompt_for_prefix: "{{ organization_prefix == '' }}"
    tacacs_group_name: "{{ organization_prefix }}-TACACS"
    auth_method_list: "{{ organization_prefix | lower }}-authc-tacacs"
    authz_method_list: "{{ organization_prefix | lower }}-authz-tacacs"
    ansible_become_password: "{{ enable | default(ansible_password) }}"
    ansible_become: true
    ansible_become_method: enable


  pre_tasks:

    - name: Prompt for username
      pause:
        prompt: "Enter username"
        echo: yes
      register: user_input
      when: ansible_user is not defined
      delegate_to: localhost
      run_once: true

    - name: Prompt for password
      pause:
        prompt: "Enter password"
        echo: no
      register: pass_input
      when: ansible_password is not defined
      delegate_to: localhost
      run_once: true
    
    - name: Prompt for organization prefix
      run_once: true
      delegate_to: localhost
      pause:
        prompt: "Enter your organization prefix (e.g., ANM, MST, LAB): "
      register: org_prefix_input
      when: prompt_for_prefix

    - name: Prompt for TACACS shared secret key
      pause:
        prompt: "Enter TACACS+ shared secret key (will not echo):"
        echo: no
      register: tacacs_key_prompt
      when: tacacs_key is not defined
      delegate_to: localhost
      run_once: true

    - name: Set username from prompt
      set_fact:
        ansible_user: "{{ user_input.user_input }}"
      when: user_input is defined and user_input.user_input is defined

    - name: Set password from prompt
      set_fact:
        ansible_password: "{{ pass_input.user_input }}"
      when: pass_input is defined and pass_input.user_input is defined

    - name: Set organization prefix from prompt
      set_fact:
        organization_prefix: "{{ org_prefix_input.user_input | upper }}"
      when: prompt_for_prefix

    - name: Update naming convention variables
      set_fact:
        tacacs_group_name: "{{ group_name | default(organization_prefix ~ '-TACACS') }}"
        auth_method_list: "{{ organization_prefix | lower }}-authc"
        authz_method_list: "{{ organization_prefix | lower }}-authz"

    - name: Set TACACS key variable
      set_fact:
        tacacs_key: "{{ tacacs_key_prompt.user_input }}"
      when: tacacs_key is not defined


    - name: Ensure AAA new-model is enabled
      ios_config:
        lines:
          - "aaa new-model"
      when: ansible_network_os in ['ios', 'iosxe']


  tasks:
    ##########################################################
    # 1. Gather existing TACACS configuration
    ##########################################################
    - name: Get current TACACS configuration
      ios_command:
        commands:
          - "show running-config | include tacacs"
      register: ios_tacacs_config
      when: ansible_network_os in ['ios', 'iosxe']

    - name: Extract existing tacacs server names
      set_fact:
        existing_named_servers: "{{ ios_tacacs_config.stdout[0] | regex_findall('tacacs server ([A-Za-z0-9_.-]+)') }}"
      when: ansible_network_os in ['ios', 'iosxe']


    - name: Gather current named TACACS servers
      ios_command:
        commands:
          - "show running-config | section ^tacacs server"
      register: tacacs_config

    ##########################################################
    # 2. Configure named TACACS+ servers
    ##########################################################

    - name: Initialize TACACS server facts
      tags: cleanup
      set_fact:
        existing_tacacs_map: {}
        existing_tacacs_keys: {}

    - name: Parse TACACS servers line-by-line
      tags: cleanup
      vars:
        config_lines: "{{ tacacs_config.stdout[0].splitlines() }}"
      block:
        - name: Loop through config lines
          set_fact:
            existing_tacacs_map: >-
              {{
                (line.startswith('tacacs server') and
                 existing_tacacs_map.update({line.split()[2]: (config_lines[config_lines.index(line)+1].split()[2] if 'address ipv4' in config_lines[config_lines.index(line)+1] else None)}) or existing_tacacs_map)
              }}
            existing_tacacs_keys: >-
              {{
                (line.startswith('tacacs server') and
                 (config_lines[config_lines.index(line)+2].split(None,1)[1] if 'key ' in config_lines[config_lines.index(line)+2] else None)
                 is not none and
                 existing_tacacs_keys.update({line.split()[2]: config_lines[config_lines.index(line)+2].split(None,1)[1]}) or existing_tacacs_keys)
              }}
          loop: "{{ config_lines }}"
          loop_control:
            label: ""
            loop_var: line
          no_log: true

    - name: Build list of currently configured TACACS IPs
      set_fact:
        existing_tacacs_ips: "{{ existing_tacacs_map.values() | list }}"

    - name: Build servers_with_names (loop-based)
      set_fact:
        servers_with_names: []

    - name: Append server_name to each required server
      set_fact:
        servers_with_names: >-
          {{
            servers_with_names + [server | combine({'server_name': (existing_tacacs_map | dict2items | selectattr('value','equalto', server.ip) | map(attribute='key') | list | first) | default(server.name) })]
          }}
      loop: "{{ tacacs_servers }}"
      loop_control:
        label: ""
        loop_var: server
      no_log: true

    - name: Add or update TACACS servers (reuse existing key if present)
      ios_config:
        parents: "tacacs server {{ server.server_name }}"
        lines:
          - "address ipv4 {{ server.ip }}"
          - "{{ 'key ' ~ existing_tacacs_keys[server.server_name] if server.server_name in existing_tacacs_keys else 'key ' ~ (server.key | default(tacacs_key)) }}"
      loop: "{{ servers_with_names }}"
      loop_control:
        label: ""
        loop_var: server
      no_log: true


    - name: Configure TACACS+ server group
      ios_config:
        parents: "aaa group server tacacs+ {{ tacacs_group_name }}"
        lines: "{{ servers_with_names | map(attribute='server_name') | map('regex_replace', '^(.*)$', 'server name \\1') | list }}"


    ##########################################################
    # 4. Enforce AAA baseline configuration
    ##########################################################
    - name: Enforce AAA authentication/authorization/accounting
      ios_config:
        lines:
          - "aaa authentication login {{ auth_method_list }} group {{ tacacs_group_name }} local enable"
          - "aaa authentication enable default group {{ tacacs_group_name }} enable"
          - "aaa authorization exec {{ authz_method_list }} group {{ tacacs_group_name }} local if-authenticated"
          - "aaa authorization commands 1 default group {{ tacacs_group_name }} local enable"
          - "aaa authorization commands 5 default group {{ tacacs_group_name }} local enable"
          - "aaa authorization commands 15 default group {{ tacacs_group_name }} local enable"
          - "aaa accounting commands 1 default start-stop group {{ tacacs_group_name }}"
          - "aaa accounting commands 5 default start-stop group {{ tacacs_group_name }}"
          - "aaa accounting commands 15 default start-stop group {{ tacacs_group_name }}"
          - "aaa accounting update newinfo periodic 120"
        match: line
      when: ansible_network_os in ['ios', 'iosxe']

    ##########################################################
    # 5. Configure VTY line authentication
    ##########################################################
    - name: Get available VTY lines
      ios_command:
        commands:
          - "show running-config | section line vty"
      register: vty_lines_output
      when: ansible_network_os in ['ios', 'iosxe']

    - name: Parse VTY line ranges (e.g., 0 4, 5 15, 0 31)
      set_fact:
        vty_groups: "{{ vty_lines_output.stdout[0] | regex_findall('line vty (\\d+)\\s+(\\d+)') | map('map', 'int') | list }}"
      when: ansible_network_os in ['ios', 'iosxe']

    - name: Configure VTY line login and authorization ranges
      ios_config:
        parents: "line vty {{ item.0 }} {{ item.1 }}"
        lines:
          - "login authentication {{ auth_method_list }}"
          - "authorization exec {{ authz_method_list }}"
        match: line
      loop: "{{ vty_groups }}"
      loop_control:
        label: "VTY {{ item.0 }}-{{ item.1 }}"
      no_log: true
      when:
        - ansible_network_os in ['ios', 'iosxe']
        - vty_groups | length > 0

    ##########################################################
    # 6. Remove stale or deprecated TACACS configurations
    ##########################################################
    - name: Gather legacy tacacs-server lines (cleaned)
      set_fact:
        legacy_tacacs_lines: >-
          {{
            ios_tacacs_config.stdout[0]
            | default('')
            | regex_findall('(?m)^[ \t]*tacacs-server.*')    
            | map('trim')                                   
            | reject('equalto', '')               
            | list
          }}
      when:
        - ansible_network_os in ['ios', 'iosxe']

    - name: Debug legacy tacacs-server lines (will remove)
      debug:
        msg:
          - "Found {{ legacy_tacacs_lines | length }} legacy tacacs-server line(s):"
          - "{{ legacy_tacacs_lines }}"
      when:
        - ansible_network_os in ['ios', 'iosxe']

    - name: Remove legacy tacacs-server lines
      ios_config:
        lines: "{{ legacy_tacacs_lines | map('regex_replace','^(.*)$','no \\1') | list }}"
      when:
        - ansible_network_os in ['ios', 'iosxe']
        - legacy_tacacs_lines | length > 0
      register: remove_legacy_tacacs_result
      ignore_errors: yes


    ##########################################################
    # clean-up
    # Remove extra & stale tacacs servers and group entries
    ##########################################################

    - block:

        ##########################################################
        # Init
        ##########################################################

        - name: clean-up | Initialize cleanup facts
          set_fact:
            tacacs_unlink_lines: []
            group_members: {}
            _cur_grp: ""

        ##########################################################
        # 1) Allowed IPs from aaa-servers.yml
        ##########################################################

        - name: clean-up | Build allowed tacacs IP list
          set_fact:
            allowed_tacacs_ips: >-
              {{
                (tacacs_servers | default([]))
                | map(attribute='ip')
                | select('defined')
                | map('string')
                | unique
                | list
              }}

        ##########################################################
        # 2) Extra configured servers (exist but not allowed)
        ##########################################################

        - name: clean-up | Compute extra configured tacacs servers
          set_fact:
            tacacs_names_to_remove: >-
              {{
                (existing_tacacs_map | default({}) | dict2items)
                | rejectattr('value', 'in', allowed_tacacs_ips)
                | map(attribute='key')
                | list
              }}
            tacacs_ips_to_remove: >-
              {{
                (existing_tacacs_map | default({}) | dict2items)
                | rejectattr('value', 'in', allowed_tacacs_ips)
                | map(attribute='value')
                | list
              }}

        ##########################################################
        # 3) Gather tacacs groups (raw text)
        ##########################################################

        - name: clean-up | Gather tacacs groups
          ios_command:
            commands:
              - "show running-config | section aaa group server tacacs"
          register: cleanup_tacacs_groups

        ##########################################################
        # 4) Parse group members (line-based, safe)
        ##########################################################

        - name: clean-up | Parse group members
          set_fact:
            _cur_grp: "{{ line.split()[-1] if line.startswith('aaa group server tacacs') else _cur_grp }}"
            group_members: >-
              {{
                group_members
                | combine(
                    (
                      { _cur_grp: ((group_members.get(_cur_grp, []) + [line.split()[-1]]) | unique) }
                      if (line.startswith('server name ') and _cur_grp != '')
                      else {}
                    ),
                    recursive=True
                  )
              }}
          loop: "{{ (cleanup_tacacs_groups.stdout[0] | default('')).splitlines() | map('trim') | list }}"
          loop_control:
            loop_var: line
            label: "hidden"

        - name: clean-up | Build group list
          set_fact:
            tacacs_groups_configured: "{{ group_members.keys() | list }}"

        ##########################################################
        # 5) Desired server names (from allowed IPs)
        ##########################################################

        - name: clean-up | Compute desired tacacs server names
          set_fact:
            desired_tacacs_names: >-
              {{
                (existing_tacacs_map | default({}) | dict2items)
                | selectattr('value', 'in', allowed_tacacs_ips)
                | map(attribute='key')
                | list
              }}

        ##########################################################
        # 6) Stale group-only members
        #    (in group, not desired, and no tacacs server object)
        ##########################################################

        - name: clean-up | Compute stale group members
          set_fact:
            stale_group_members: >-
              {{
                (
                  group_members.values() | list | flatten | unique
                )
                | difference(desired_tacacs_names | default([]))
                | difference((existing_tacacs_map | default({})).keys() | list)
              }}

        ##########################################################
        # 7) Build unlink commands (extra + stale)
        ##########################################################
          
        - name: clean-up | Build unlink ops (parents + lines)
          set_fact:
            tacacs_unlink_ops: "{{ (tacacs_unlink_ops | default([])) + ([{'parent': 'aaa group server tacacs ' ~ grp, 'lines': bad_lines}] if (bad_lines | length > 0) else []) }}"
          loop: "{{ tacacs_groups_configured | default([]) }}"
          loop_control:
            loop_var: grp
          vars:
            members: "{{ group_members.get(grp, []) | default([]) }}"
            bad_in_group: >-
              {{
                members
                | intersect((tacacs_names_to_remove | default([])) + (stale_group_members | default([])))
                | unique
                | list
              }}
            bad_lines: "{{ bad_in_group | map('regex_replace', '^', 'no server name ') | list }}"

        - name: clean-up | Show unlink ops plan
          debug:
            var: tacacs_unlink_ops



        ##########################################################
        # 8) Show plan
        ##########################################################

        - name: clean-up | Show unlink/delete plan
          debug:
            msg:
              allowed_tacacs_ips: "{{ allowed_tacacs_ips }}"
              existing_tacacs_map: "{{ existing_tacacs_map }}"
              desired_tacacs_names: "{{ desired_tacacs_names }}"
              tacacs_names_to_remove: "{{ tacacs_names_to_remove }}"
              stale_group_members: "{{ stale_group_members }}"
              group_members: "{{ group_members }}"
              tacacs_unlink_lines: "{{ tacacs_unlink_lines }}"

        ##########################################################
        # 9) APPLY: unlink first, then delete
        ##########################################################

        - name: clean-up | Unlink extra & stale servers from groups
          ios_config:
            parents: "{{ item.parent }}"
            lines: "{{ item.lines }}"
          loop: "{{ tacacs_unlink_ops | default([]) }}"
          loop_control:
            label: "{{ item.parent }}"
          when: (tacacs_unlink_ops | default([])) | length > 0


        - name: clean-up | Delete extra tacacs server objects
          ios_config:
            lines: "{{ tacacs_names_to_remove | map('regex_replace', '^(.*)$', 'no tacacs server \\1') | list }}"
          when: (tacacs_names_to_remove | length) > 0

        ##########################################################
        # 10) Clean Up Stale groups
        ##########################################################
        - name: clean-up | Re-gather tacacs groups after changes
          ios_command:
            commands:
              - "show running-config | section aaa group server tacacs"
          register: cleanup_tacacs_groups_after

        - name: clean-up | Compute empty tacacs groups (no server name entries)
          set_fact:
            empty_tacacs_groups: []
            _cur_grp: ""
            _cur_has_member: false

        - name: clean-up | Scan groups and detect empties
          set_fact:
            # when we hit a new group header, finalize the previous group:
            empty_tacacs_groups: >-
              {{
                empty_tacacs_groups
                + ([ _cur_grp ] if (_cur_grp != '' and (not _cur_has_member)) else [])
                if (line.startswith('aaa group server tacacs '))
                else empty_tacacs_groups
              }}
            _cur_grp: "{{ (line.split()[-1]) if line.startswith('aaa group server tacacs ') else _cur_grp }}"
            _cur_has_member: "{{ true if line.startswith('server name ') else _cur_has_member }}"
          loop: "{{ (cleanup_tacacs_groups_after.stdout[0] | default('')).splitlines() | map('trim') | list }}"
          loop_control:
            loop_var: line
            label: "hidden"

        - name: clean-up | Finalize last group empty check
          set_fact:
            empty_tacacs_groups: "{{ empty_tacacs_groups + ([ _cur_grp ] if (_cur_grp != '' and (not _cur_has_member)) else []) }}"

        - name: clean-up | Remove empty tacacs groups
          ios_config:
            lines: "{{ empty_tacacs_groups | map('regex_replace', '^(.*)$', 'no aaa group server tacacs \\1') | list }}"
          when: (empty_tacacs_groups | default([])) | length > 0

        - name: clean-up | Show empty groups removed
          debug:
            msg:
              empty_tacacs_groups: "{{ empty_tacacs_groups | default([]) }}"

        ##########################################################
        # 11) Remove Unused/Stale AAA Method lists
        ##########################################################
        - name: clean-up | Gather AAA server groups after cleanup (tacacs + tacacs)
          ios_command:
            commands:
              - "show running-config | section aaa group server"
          register: aaa_groups_after

        - name: clean-up | Build list of existing AAA groups after cleanup (all types)
          set_fact:
            aaa_groups_existing_after: >-
              {{
                (aaa_groups_after.stdout[0] | default('')).splitlines()
                | map('trim')
                | select('match', '^aaa group server ')
                | map('split')
                | map('last')
                | unique
                | list
              }}

        - name: clean-up | Gather AAA section after cleanup
          ios_command:
            commands:
              - "show running-config | section aaa"
          register: aaa_after

        - name: clean-up | Collect AAA METHOD lines that reference a group (exclude aaa group server)
          set_fact:
            aaa_group_lines: >-
              {{
                (aaa_after.stdout[0] | default('')).splitlines()
                | map('trim')
                | select('match', '^aaa (authentication|authorization|accounting) ')
                | select('search', ' group ')
                | list
              }}


        - name: clean-up | Compute AAA lines to remove (group missing)
          set_fact:
            aaa_lines_to_remove: "{{ (aaa_lines_to_remove | default([])) + ([line] if remove_me else []) }}"
          loop: "{{ aaa_group_lines | default([]) }}"
          loop_control:
            loop_var: line
            label: "hidden"
          vars:
            grp: "{{ (line | regex_findall('\\bgroup\\s+(\\S+)') | first | default('')) }}"
            remove_me: >-
              {{
                (grp | length > 0)
                and (grp not in (aaa_groups_existing_after | default([])))
                and (not line.startswith('aaa group server '))
              }}

        - name: clean-up | Show AAA lines to remove (missing group)
          debug:
            msg:
              aaa_groups_existing_after: "{{ aaa_groups_existing_after | default([]) }}"
              aaa_lines_to_remove: "{{ aaa_lines_to_remove | default([]) }}"

        - name: clean-up | Remove AAA lines that reference missing groups
          ios_config:
            lines: "{{ aaa_lines_to_remove | default([]) | map('regex_replace', '^', 'no ') | list }}"
          when: (aaa_lines_to_remove | default([])) | length > 0
      tags:
        - cleanup



    ##########################################################
    # 7. Save and verify
    ##########################################################
    - name: Save running configuration
      ios_command:
        commands:
          - "write memory"
      when: ansible_network_os in ['ios', 'iosxe']
      vars:
        ansible_command_timeout: 120
        ansible_connect_timeout: 120

    - name: Test AAA Group
      tags: validate
      ios_command:
        commands:
          - "test aaa group {{ tacacs_group_name }} {{ ansible_user }} {{ ansible_password }} new-code"
        wait_for:
          - result[0] contains successfully
      register: tacacs_test
      when: ansible_network_os in ['ios', 'iosxe']
      vars:
        ansible_command_timeout: 120
        ansible_connect_timeout: 120


    - name: Verify TACACS+ and AAA configuration
      tags: validate
      ios_command:
        commands:
          - "show running-config | section aaa"
          - "show running-config | section line vty"
      register: verify_config
      when: ansible_network_os in ['ios', 'iosxe']

    - name: Display verification summary
      tags: validate
      debug:
        msg: |
          TACACS+ Configuration Verified
          --------------------------------
          Group: {{ tacacs_group_name | default('N/A') }}
          Authentication: {{ auth_method_list | default('N/A') }}
          Authorization: {{ authz_method_list | default('N/A') }}
          Test: {{ tacacs_test | default('Failed') }}

          --- AAA Section ---
          {{ verify_config.stdout[0] | default('N/A') }}

          --- VTY Lines Section ---
          {{ verify_config.stdout[1] | default('N/A') }}